# PortProxy

## 01 - Manual

### 1.1 - Usage

Note: `netsh portproxy` must be executed with administrative rights

```
C:\> netsh interface portproxy add v4tov4 listenport=<LPORT> listenaddress=<LHOST> connectport=<FPORT> connectaddress=<FHOST>

C:\> netsh interface portproxy show v4tov4

C:\> netsh interface portproxy delete v4tov4 listenaddress=<LHOST> listenport=<LPORT>
```

### 1.2 - Scenarios

#### 1.2.1 - Bind SSH Port

- Grab the SSH port number

```
C:\> netsh interface portproxy add v4tov4 listenport=4242 listenaddress=<192.168.56.102 | 0.0.0.0> connectport=22 connectaddress=192.168.0.101
```

- In command prompt

```
C:\> netstat -na | findstr "4242"

C:\> tasklist | findstr :4242
```

- In powershell

`PS C:\> Test-NetConnection -ComputerName localhost -Port 4242`

- Add a firewall rule

```
C:\> netsh advfirewall firewall add rule name="Port Forward SSH" protocol=tcp dir=in localip=192.168.56.102 localport=4242 action=allow

```

`$ ssh <username>@192.168.56.102 -p 4242`

## 02 - Metasploit

```
msf > use post/windows/manage/portproxy

msf post(windows/manage/portproxy) > options

Module options (post/windows/manage/portproxy):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   CONNECT_ADDRESS                   yes       IPv4/IPv6 address to which to connect.
   CONNECT_PORT                      yes       Port number to which to connect.
   IPV6_XP          true             yes       Install IPv6 on Windows XP (needed for v4tov4).
   LOCAL_ADDRESS                     yes       IPv4/IPv6 address to which to listen.
   LOCAL_PORT                        yes       Port number to which to listen.
   SESSION                           yes       The session to run this module on
   TYPE             v4tov4           yes       Type of forwarding (Accepted: v4tov4, v6tov6, v6tov4, v4tov6)

msf post(windows/manage/portproxy) > set session <session_id>

msf post(windows/manage/portproxy) > set connect_address <FHOST>

msf post(windows/manage/portproxy) > set connect_port <FPORT>

msf post(windows/manage/portproxy) > set local_address <LHOST>

msf post(windows/manage/portproxy) > set local_port <LPORT>

msf post(windows/manage/portproxy) > set type <v4tov4 | v6tov6 | v6tov4 | v4tov6>

msf post(windows/manage/portproxy) > set ipv6_xp <true | false>

msf post(windows/manage/portproxy) > run
```

## References

- [Metasploit Chain of Proxies](https://www.shelliscoming.com/2013/08/metasploit-chain-of-proxies-with.html)

- [Netsh Interface PortProxy](https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-interface-portproxy)

- [SlayerLabs Tunneling Quick Guide](https://posts.slayerlabs.com/tunneling-quick-guide/)

- [PayloadsAllTheThings Network Pivoting Techniques](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Network%20Pivoting%20Techniques.md)

- [How to Redirect a Port Using Netsh Interface PortProxy Command in Windows](https://www.computertechblog.com/how-to-redirect-a-port-using-netsh-interface-portproxy-command-in-windows/)

- [Configure Port Forwarding on Windows Using Netsh](https://bobcares.com/blog/configure-port-forwarding-on-windows-using-netsh/)

- [Windows Port Forward](https://embracethered.com/blog/posts/2020/windows-port-forward/)